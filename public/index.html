<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CEREBELLAR-EXTRACT - Data Extraction Tool</title>

  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-performance-compat.js"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2c3e50;
      --accent: #f39c12;
      --accent-hover: #e67e22;
      --ai-color: #8e44ad;
      --ai-bg: #f5eef8;
      --success: #27ae60;
      --bg-grey: #eef2f5;
      --border: #dce4ec;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg-grey);
      color: #333;
    }

    .app {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* --- LEFT PANEL: PDF VIEWER --- */
    .pdf-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #525659;
      /* Neutral dark grey for PDF backdrop */
      color: white;
      overflow: hidden;
      position: relative;
    }

    .pdf-header {
      padding: 12px 20px;
      background: #323639;
      border-bottom: 1px solid #000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }

    .pdf-header h2 {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* File upload styling */
    .file-upload-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.2s;
      position: relative;
      overflow: hidden;
    }

    .file-upload-btn:hover {
      background: var(--primary-dark);
    }

    .file-upload-btn input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    /* Controls Bar */
    .pdf-controls {
      padding: 8px 16px;
      background: #424649;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #000;
    }

    .control-btn {
      padding: 4px 8px;
      background: transparent;
      color: #f0f0f0;
      border: 1px solid #666;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .control-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
    }

    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Annotation Bar */
    .annotation-bar {
      padding: 10px 16px;
      background: #fff;
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 1px solid var(--border);
      color: #333;
    }

    .field-select {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: white;
      font-size: 13px;
      min-width: 200px;
    }

    .toggle-highlight-btn {
      padding: 6px 12px;
      background: var(--bg-grey);
      color: #555;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .toggle-highlight-btn.active {
      background: #fff3cd;
      color: #856404;
      border-color: #ffeeba;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .toggle-highlight-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* PDF Canvas Container */
    .pdf-viewer-container {
      flex: 1;
      overflow: auto;
      padding: 40px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background-image: radial-gradient(#666 1px, transparent 1px);
      background-size: 20px 20px;
    }

    .pdf-canvas-wrapper {
      position: relative;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      background: white;
    }

    #pdf-canvas {
      display: block;
    }

    .highlight-layer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .highlight {
      position: absolute;
      background: rgba(255, 235, 59, 0.3);
      border: 1px solid rgba(255, 193, 7, 0.8);
      pointer-events: auto;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .highlight:hover {
      background: rgba(255, 235, 59, 0.5);
      z-index: 10;
    }

    /* Citation highlights (from Claude Native Citations) */
    .citation-highlight {
      position: absolute;
      background: rgba(138, 43, 226, 0.25);
      border: 1px solid rgba(138, 43, 226, 0.6);
      pointer-events: auto;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 2px;
    }

    .citation-highlight:hover {
      background: rgba(138, 43, 226, 0.4);
      z-index: 10;
    }

    .citation-highlight.active {
      background: rgba(138, 43, 226, 0.5);
      border-width: 2px;
      box-shadow: 0 0 8px rgba(138, 43, 226, 0.5);
    }

    /* Citation panel styles */
    .citation-panel {
      background: #f8f4ff;
      border: 1px solid #d4c4e8;
      border-radius: 6px;
      margin-bottom: 15px;
      overflow: hidden;
    }

    .citation-panel-header {
      padding: 10px 12px;
      background: linear-gradient(135deg, #8e44ad, #9b59b6);
      color: white;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .citation-card {
      padding: 10px 12px;
      border-bottom: 1px solid #e8dff2;
      cursor: pointer;
      transition: background 0.2s;
    }

    .citation-card:last-child {
      border-bottom: none;
    }

    .citation-card:hover {
      background: #f0e8f8;
    }

    .citation-card.active {
      background: #e8d8f4;
      border-left: 3px solid #8e44ad;
    }

    .citation-field {
      font-size: 11px;
      font-weight: 600;
      color: #8e44ad;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .citation-value {
      font-size: 13px;
      color: #2c3e50;
      margin-bottom: 6px;
    }

    .citation-source {
      font-size: 11px;
      color: #666;
      font-style: italic;
      background: white;
      padding: 6px 8px;
      border-radius: 4px;
      border-left: 2px solid #9b59b6;
      max-height: 60px;
      overflow-y: auto;
    }

    .citation-meta {
      font-size: 10px;
      color: #999;
      margin-top: 6px;
      display: flex;
      gap: 12px;
    }

    /* --- RIGHT PANEL: EXTRACTION FORM --- */
    .extraction-panel {
      width: 480px;
      background: white;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border);
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.05);
      z-index: 20;
    }

    .extraction-header {
      padding: 20px 20px 0 20px;
      /* Reduced bottom padding for tabs */
      background: white;
      border-bottom: 1px solid var(--border);
    }

    .header-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .extraction-header h2 {
      font-size: 18px;
      color: var(--secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .save-status {
      font-size: 11px;
      color: #7f8c8d;
      display: flex;
      align-items: center;
      gap: 4px;
      background: #f8f9fa;
      padding: 2px 8px;
      border-radius: 12px;
      border: 1px solid #eee;
    }

    .save-status.saving {
      color: var(--accent);
    }

    .save-status.saved {
      color: var(--success);
    }

    /* TABS */
    .panel-tabs {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 8px 0;
      font-size: 13px;
      font-weight: 600;
      color: #7f8c8d;
      cursor: pointer;
      position: relative;
    }

    .tab-btn.active {
      color: var(--primary);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      /* Overlap border */
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
    }

    /* AI Buttons */
    .btn-ai-magic {
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      background: linear-gradient(135deg, #8e44ad, #9b59b6);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 5px rgba(142, 68, 173, 0.3);
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .btn-ai-magic:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(142, 68, 173, 0.4);
    }

    .btn-ai-magic:active {
      transform: translateY(0);
    }

    .btn-ai-magic:disabled {
      background: #ccc;
      box-shadow: none;
      cursor: not-allowed;
    }

    .btn-quality-check {
      padding: 4px 8px;
      font-size: 11px;
      background: #f8f9fa;
      color: var(--ai-color);
      border: 1px solid var(--ai-color);
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .btn-quality-check:hover {
      background: var(--ai-bg);
    }

    /* Form Body */
    .extraction-content {
      flex: 1;
      overflow-y: auto;
      background: #fcfcfc;
      position: relative;
    }

    .extraction-form-container {
      padding: 20px;
    }

    /* Chat Interface */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #f8f9fa;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.4;
      position: relative;
    }

    .message.user {
      align-self: flex-end;
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 2px;
    }

    .message.assistant {
      align-self: flex-start;
      background: white;
      border: 1px solid var(--border);
      color: #2c3e50;
      border-bottom-left-radius: 2px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .message.system {
      align-self: center;
      background: transparent;
      color: #7f8c8d;
      font-size: 11px;
      font-style: italic;
      border: none;
      box-shadow: none;
      text-align: center;
    }

    .quick-prompts {
      display: flex;
      gap: 8px;
      padding: 10px 15px;
      overflow-x: auto;
      white-space: nowrap;
      border-top: 1px solid var(--border);
      background: white;
      -ms-overflow-style: none;
      /* IE and Edge */
      scrollbar-width: none;
      /* Firefox */
    }

    .quick-prompts::-webkit-scrollbar {
      display: none;
    }

    .prompt-pill {
      padding: 6px 12px;
      background: #f0f2f5;
      color: #555;
      border: 1px solid #e4e6eb;
      border-radius: 16px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .prompt-pill:hover {
      background: var(--ai-bg);
      color: var(--ai-color);
      border-color: var(--ai-color);
    }

    .chat-input-area {
      padding: 15px;
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      outline: none;
    }

    .chat-input:focus {
      border-color: var(--primary);
    }

    .btn-send {
      background: var(--primary);
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    /* Accordion Sections */
    .form-section {
      margin-bottom: 20px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .form-section:last-child {
      margin-bottom: 0;
    }

    .section-header {
      padding: 12px 15px;
      background: #f8f9fa;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      transition: background 0.2s;
    }

    .section-header:hover {
      background: #eef2f5;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-actions {
      display: flex;
      gap: 8px;
    }

    .btn-clear-section {
      padding: 2px 6px;
      font-size: 10px;
      color: #999;
      background: transparent;
      border: 1px solid #ddd;
      border-radius: 3px;
      cursor: pointer;
    }

    .btn-clear-section:hover {
      background: #fee;
      color: #c0392b;
      border-color: #e74c3c;
    }

    .section-body {
      padding: 15px;
      display: block;
    }

    .section-body.collapsed {
      display: none;
    }

    /* Form Inputs */
    .form-group {
      margin-bottom: 14px;
      position: relative;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #7f8c8d;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .input-wrapper {
      position: relative;
      display: flex;
      align-items: stretch;
    }

    .form-control {
      flex: 1;
      width: 100%;
      padding: 10px 12px;
      padding-right: 35px;
      /* space for badge */
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
      line-height: 1.5;
      color: #2c3e50;
      transition: all 0.2s;
      background: white;
    }

    .input-wrapper textarea.form-control {
      padding-right: 12px;
      /* Textarea suggestion button is outside or floating */
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      z-index: 2;
    }

    textarea.form-control {
      min-height: 70px;
      resize: vertical;
    }

    /* Input Actions (Magic Wand) */
    .input-actions {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 4px;
      z-index: 5;
    }

    textarea~.input-actions {
      top: 12px;
      transform: none;
    }

    .btn-suggest {
      background: none;
      border: none;
      cursor: pointer;
      color: #bdc3c7;
      padding: 2px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-suggest:hover {
      color: var(--ai-color);
      background: var(--ai-bg);
      transform: scale(1.1);
    }

    .btn-suggest.loading {
      animation: spin 1s linear infinite;
      color: var(--ai-color);
      cursor: wait;
    }

    /* AI Filled State */
    .form-control.ai-filled {
      border-color: #d2b4de;
      background: linear-gradient(to right, #fff, #fcf4ff);
    }

    .ai-badge {
      position: absolute;
      right: -20px;
      /* Outside */
      top: 10px;
      font-size: 14px;
      color: var(--ai-color);
      pointer-events: none;
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* Selected State for highlighting */
    .form-control.field-focused {
      border-color: var(--accent);
      background: #fffcf5;
    }

    /* Footer Actions */
    .panel-footer {
      padding: 15px 20px;
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }

    .action-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-export-json {
      background: #27ae60;
      color: white;
    }

    .btn-export-json:hover {
      background: #219150;
    }

    .btn-export-sheets {
      background: #fff;
      color: #27ae60;
      border: 1px solid #27ae60;
    }

    .btn-export-sheets:hover {
      background: #f0f9f4;
    }

    /* Annotations List */
    .annotations-container {
      margin-top: 20px;
    }

    .annotation-card {
      padding: 10px;
      background: white;
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .annotation-card:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .annotation-card strong {
      color: var(--secondary);
      display: block;
      margin-bottom: 4px;
    }

    .annotation-card p {
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Toast & Loading */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--ai-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes popIn {
      0% {
        transform: scale(0);
      }

      100% {
        transform: scale(1);
      }
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 24px;
      background: #333;
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideUp 0.3s ease;
    }

    .toast.error {
      background: #e74c3c;
    }

    .toast.success {
      background: #27ae60;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Scrollbar polish */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }

    /* ============================================
       DETAILED EXTRACTION: Grid Layouts & Dynamic Fields
       ============================================ */

    /* Grid Layouts for Detailed Extraction */
    .grid-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .grid-3col {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    /* mRS Distribution Grid (7 columns for scores 0-6) */
    .grid-mrs {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    .grid-mrs .form-group {
      margin-bottom: 0;
    }

    .grid-mrs .form-group label {
      text-align: center;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 4px;
      font-size: 14px;
    }

    .grid-mrs .form-group input {
      text-align: center;
      font-size: 14px;
    }

    /* Dynamic Field Container */
    .dynamic-container {
      background: #ffffff;
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      position: relative;
      transition: all 0.2s ease;
    }

    .dynamic-container:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
    }

    .dynamic-container h4 {
      color: var(--secondary);
      font-size: 16px;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }

    .dynamic-container h5 {
      color: var(--primary);
      font-size: 14px;
      margin: 12px 0 8px 0;
      font-weight: 600;
    }

    /* Remove Button for Dynamic Fields */
    .remove-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 6px 12px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .remove-btn:hover {
      background: #c0392b;
      transform: scale(1.05);
    }

    /* Add Field Button */
    .add-field-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 16px;
    }

    .add-field-btn:hover {
      background: #229954;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
    }

    .add-field-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Field Section Headers */
    .field-section {
      margin-bottom: 32px;
    }

    .field-section > h3 {
      color: var(--secondary);
      font-size: 18px;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 3px solid var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .field-section-description {
      color: #666;
      font-size: 13px;
      margin-bottom: 12px;
      font-style: italic;
    }

    /* Arm Selector Specific Styling */
    .arm-selector {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
    }

    .arm-selector:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* Empty State for Dynamic Fields */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-style: italic;
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // --- GLOBAL CONFIGURATION ---

    // Firebase Config - Updated for Firebase AI Logic / Data Connect
    const firebaseConfig = {
      apiKey: "AIzaSyAMr_rIvuAvRyvAcAsLTBOLrKiw8ikvQFQ",
      authDomain: "cerebellar-extraction.firebaseapp.com",
      projectId: "cerebellar-extraction",
      storageBucket: "cerebellar-extraction.firebasestorage.app",
      messagingSenderId: "1019192870442",
      appId: "1:1019192870442:web:0bea61ff2c9435c63c6553",
      measurementId: "G-GH46289Z2Z"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const app = firebase.app();
    const auth = firebase.auth();
    const db = firebase.firestore();
    const analytics = firebase.analytics();
    const perf = firebase.performance();

    const appId = "cerebellar-extraction";
    const apiKey = "AIzaSyABpwQcfzPOAswAV6Sa-CtBULJRULiD-uE"; // Gemini API key

    // Inline SVGs to replace Lucide Icons
    const Icons = {
      Wand2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z" /><path d="m14 7 3 3" /><path d="M5 6v4" /><path d="M19 14v4" /><path d="M10 2v2" /><path d="M7 8H3" /><path d="M21 16h-4" /><path d="M11 3H9" /></svg>,
      MessageSquare: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></svg>,
      FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" /></svg>,
      Send: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m22 2-7 20-4-9-9-4Z" /><path d="M22 2 11 13" /></svg>,
      ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6" /></svg>,
      ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m9 18 6-6-6-6" /></svg>,
      Quote: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z" /><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z" /></svg>,
      Activity: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2" /></svg>,
      Cloud: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17.5 19c0-1.7-1.3-3-3-3h-11a3 3 0 0 1-.3-6 5 5 0 0 1 9.7-1.5 4 4 0 0 1 7.9 2.3 2.2 2.2 0 0 1 .2.9 2.5 2.5 0 0 1-2.5 2.3Z" /></svg>,
      Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 6 9 17l-5-5" /></svg>
    };

    const FIELD_MAP = {
      "Study ID": "study_id",
      "Authors": "authors",
      "Year": "year",
      "Title": "title",
      "Sample Size": "population.sample_size",
      "Mean Age": "population.mean_age",
      "Inclusion Criteria": "population.inclusion_criteria",
      "Intervention": "intervention.procedure",
      "Intervention Timing": "intervention.timing_hours",
      "Intervention Technique": "intervention.technique",
      "Comparator": "comparator",
      "Mortality": "outcomes.mortality",
      "mRS Outcome": "outcomes.mRS_favorable",
      "Complications": "outcomes.complications",
      "Length of Stay": "outcomes.length_of_stay",
      "Follow-up Duration": "timing.follow_up_duration",
      "Study Design": "study_design",
      "Newcastle-Ottawa Score": "newcastle_ottawa_score"
    };

    const GEMINI_SCHEMA = {
      type: "OBJECT",
      properties: {
        study_id: { type: "STRING", description: "First author last name + year e.g. Smith2023" },
        authors: { type: "STRING", description: "Authors string e.g. Smith et al." },
        year: { type: "STRING" },
        title: { type: "STRING" },
        population: {
          type: "OBJECT",
          properties: {
            sample_size: { type: "STRING" },
            mean_age: { type: "STRING" },
            inclusion_criteria: { type: "STRING" },
          }
        },
        intervention: {
          type: "OBJECT",
          properties: {
            procedure: { type: "STRING" },
            timing_hours: { type: "STRING" },
            technique: { type: "STRING" }
          }
        },
        outcomes: {
          type: "OBJECT",
          properties: {
            mortality: { type: "STRING" },
            mRS_favorable: { type: "STRING" },
            complications: { type: "STRING" },
            length_of_stay: { type: "STRING" }
          }
        },
        study_design: { type: "STRING" },
      }
    };

    const QUICK_PROMPTS = [
      "Summarize key findings",
      "Assess risk of bias",
      "List exclusion criteria",
      "Describe the intervention"
    ];

    // --- GLOBAL UTILS ---
    const cleanExtractedText = (text) => {
      if (!text) return "";
      return text.replace(/(\w)-\n(\w)/g, '$1$2').replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
    };

    /**
     * Convert PDF coordinates to canvas pixel coordinates
     * PDF coordinates: origin at bottom-left, y increases upward
     * Canvas coordinates: origin at top-left, y increases downward
     */
    const pdfToCanvasCoords = (pdfX, pdfY, pdfWidth, pdfHeight, viewport) => {
      // Apply viewport transformation
      const [a, b, c, d, e, f] = viewport.transform;

      // PDF coords to canvas coords using transformation matrix
      // For standard viewport: x' = scale * x, y' = height - (scale * y)
      const canvasX = pdfX * viewport.scale;
      const canvasY = viewport.height - (pdfY * viewport.scale);
      const canvasWidth = pdfWidth * viewport.scale;
      const canvasHeight = pdfHeight * viewport.scale;

      return {
        left: canvasX,
        top: canvasY - canvasHeight, // Adjust for height since y is bottom of rect in PDF
        width: canvasWidth,
        height: canvasHeight
      };
    };

    /**
     * Convert citation highlight from PDF space to canvas space
     */
    const convertCitationHighlight = (citation, viewport) => {
      return {
        ...citation,
        canvasRect: pdfToCanvasCoords(
          citation.x,
          citation.y,
          citation.width,
          citation.height,
          viewport
        )
      };
    };

    /**
     * Call Claude API with native citations enabled via Firebase Callable Function
     * Uses httpsCallable for automatic auth handling and type-safe serialization
     */
    const getFunctions = () => {
      // Get Firebase Functions instance (uses default region us-central1)
      return firebase.functions();
    };

    const callClaudeWithCitations = async (pdfText, positions = null, extractionPrompt = null) => {
      try {
        const functions = getFunctions();
        const extractCitations = functions.httpsCallable('extractCitations');

        // Call the callable function - auth token automatically included
        const result = await extractCitations({
          pdfText,
          positions,
          extractionPrompt
        });

        return result.data; // Callable functions return {data: ...}
      } catch (error) {
        // Firebase callable errors have code and message
        console.warn('Citation API error:', error.code, error.message);
        // Return null to allow fallback to Gemini
        return null;
      }
    };

    /**
     * Extract text with positions from PDF pages
     * Returns array of position objects for citation mapping
     */
    const extractPdfPositions = async (pdfDoc) => {
      const positions = [];
      let globalCharIndex = 0;

      for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
        const page = await pdfDoc.getPage(pageNum);
        const textContent = await page.getTextContent();

        for (const item of textContent.items) {
          if (!item.str) continue;

          const text = item.str;
          const startChar = globalCharIndex;
          const endChar = globalCharIndex + text.length;

          positions.push({
            text,
            startChar,
            endChar,
            x: item.transform[4],
            y: item.transform[5],
            width: item.width || 0,
            height: item.height || 10,
            page: pageNum,
          });

          globalCharIndex = endChar + 1; // +1 for space separator
        }

        globalCharIndex += 2; // Page separator
      }

      return positions;
    };

    const callGemini = async (prompt, schema = null) => {
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

      const payload = {
        contents: [{ parts: [{ text: prompt }] }],
      };

      if (schema) {
        payload.generationConfig = { responseMimeType: "application/json", responseSchema: schema };
      }

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error("API Error");
      const result = await response.json();
      return result.candidates?.[0]?.content?.parts?.[0]?.text;
    };

    // --- COMPONENTS ---

    // Detailed Extraction Field Components
    const IndicationField = ({ data, onUpdate, onRemove, index }) => (
      <div className="dynamic-container">
        <h4>Indication {index + 1}</h4>
        <button className="remove-btn" onClick={onRemove}>Remove</button>
        <div className="grid-2col">
          <div className="form-group">
            <label>Sign/Symptom</label>
            <select
              value={data.sign}
              onChange={(e) => onUpdate('sign', e.target.value)}
              className="form-control"
            >
              <option value="">Select...</option>
              <option value="Drowsiness">Drowsiness</option>
              <option value="GCS_Drop">Drop in GCS</option>
              <option value="Imaging_Mass_Effect">Imaging signs of mass effect</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div className="form-group">
            <label>Count (N)</label>
            <input
              type="number"
              value={data.count}
              onChange={(e) => onUpdate('count', e.target.value)}
              className="form-control"
            />
          </div>
        </div>
      </div>
    );

    const InterventionField = ({ data, onUpdate, onRemove, index }) => (
      <div className="dynamic-container">
        <h4>Intervention Type {index + 1}</h4>
        <button className="remove-btn" onClick={onRemove}>Remove</button>
        <div className="form-group">
          <label>Surgical Type</label>
          <select
            value={data.type}
            onChange={(e) => onUpdate('type', e.target.value)}
            className="form-control"
          >
            <option value="">Select...</option>
            <option value="SDC_EVD">SDC + EVD</option>
            <option value="SDC_ALONE">SDC Alone</option>
            <option value="EVD_ALONE">EVD Alone</option>
          </select>
        </div>
        <div className="form-group">
          <label>Time To Surgery (Hours)</label>
          <input
            type="number"
            step="0.1"
            value={data.timeToSurgery}
            onChange={(e) => onUpdate('timeToSurgery', e.target.value)}
            className="form-control"
          />
        </div>
        <div className="form-group">
          <label>Duraplasty?</label>
          <select
            value={data.duraplasty}
            onChange={(e) => onUpdate('duraplasty', e.target.value)}
            className="form-control"
          >
            <option value="null">Unknown</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
    );

    const StudyArmField = ({ data, onUpdate, onRemove, index }) => (
      <div className="dynamic-container">
        <h4>Study Arm {index + 1}</h4>
        <button className="remove-btn" onClick={onRemove}>Remove</button>
        <div className="grid-2col">
          <div className="form-group">
            <label>Label</label>
            <input
              type="text"
              value={data.label}
              onChange={(e) => onUpdate('label', e.target.value)}
              className="form-control"
              placeholder="e.g., SDC Group, Control"
            />
          </div>
          <div className="form-group">
            <label>Sample Size (N)</label>
            <input
              type="number"
              value={data.sampleSize}
              onChange={(e) => onUpdate('sampleSize', e.target.value)}
              className="form-control"
            />
          </div>
        </div>
      </div>
    );

    const MortalityField = ({ data, onUpdate, onRemove, index, availableArms }) => (
      <div className="dynamic-container">
        <h4>Mortality Data Point {index + 1}</h4>
        <button className="remove-btn" onClick={onRemove}>Remove</button>
        <div className="grid-2col">
          <div className="form-group">
            <label>Arm</label>
            <select
              value={data.arm}
              onChange={(e) => onUpdate('arm', e.target.value)}
              className="form-control arm-selector"
            >
              <option value="">Select Arm...</option>
              {availableArms.map(arm => (
                <option key={arm.id} value={arm.label}>{arm.label}</option>
              ))}
            </select>
          </div>
          <div className="form-group">
            <label>Timepoint</label>
            <input
              type="text"
              value={data.timepoint}
              onChange={(e) => onUpdate('timepoint', e.target.value)}
              className="form-control"
              placeholder="e.g., 30 days, 90 days"
            />
          </div>
        </div>
        <div className="grid-2col">
          <div className="form-group">
            <label>Deaths (N)</label>
            <input
              type="number"
              value={data.deaths}
              onChange={(e) => onUpdate('deaths', e.target.value)}
              className="form-control"
            />
          </div>
          <div className="form-group">
            <label>Total (N)</label>
            <input
              type="number"
              value={data.total}
              onChange={(e) => onUpdate('total', e.target.value)}
              className="form-control"
            />
          </div>
        </div>
      </div>
    );

    const MRSField = ({ data, onUpdate, onRemove, index, availableArms }) => (
      <div className="dynamic-container">
        <h4>mRS Data Point {index + 1}</h4>
        <button className="remove-btn" onClick={onRemove}>Remove</button>
        <div className="grid-2col">
          <div className="form-group">
            <label>Arm</label>
            <select
              value={data.arm}
              onChange={(e) => onUpdate('arm', e.target.value)}
              className="form-control arm-selector"
            >
              <option value="">Select Arm...</option>
              {availableArms.map(arm => (
                <option key={arm.id} value={arm.label}>{arm.label}</option>
              ))}
            </select>
          </div>
          <div className="form-group">
            <label>Timepoint</label>
            <input
              type="text"
              value={data.timepoint}
              onChange={(e) => onUpdate('timepoint', e.target.value)}
              className="form-control"
              placeholder="e.g., 90 days, 6 months"
            />
          </div>
        </div>
        <h5>mRS Distribution (Counts for scores 0-6)</h5>
        <div className="grid-mrs">
          {[0, 1, 2, 3, 4, 5, 6].map(score => (
            <div key={score} className="form-group">
              <label>{score}</label>
              <input
                type="number"
                value={data.scores[score]}
                onChange={(e) => onUpdate(`score_${score}`, e.target.value)}
                className="form-control"
              />
            </div>
          ))}
        </div>
      </div>
    );

    const ComplicationField = ({ data, onUpdate, onRemove, index, availableArms }) => (
      <div className="dynamic-container">
        <h4>Complication {index + 1}</h4>
        <button className="remove-btn" onClick={onRemove}>Remove</button>
        <div className="grid-2col">
          <div className="form-group">
            <label>Description</label>
            <input
              type="text"
              value={data.description}
              onChange={(e) => onUpdate('description', e.target.value)}
              className="form-control"
              placeholder="e.g., Infection, Hemorrhage"
            />
          </div>
          <div className="form-group">
            <label>Arm</label>
            <select
              value={data.arm}
              onChange={(e) => onUpdate('arm', e.target.value)}
              className="form-control arm-selector"
            >
              <option value="">Select Arm...</option>
              {availableArms.map(arm => (
                <option key={arm.id} value={arm.label}>{arm.label}</option>
              ))}
            </select>
          </div>
        </div>
        <div className="form-group">
          <label>Count (N)</label>
          <input
            type="number"
            value={data.count}
            onChange={(e) => onUpdate('count', e.target.value)}
            className="form-control"
          />
        </div>
      </div>
    );

    const PredictorField = ({ data, onUpdate, onRemove, index }) => (
      <div className="dynamic-container">
        <h4>Predictor Analysis {index + 1}</h4>
        <button className="remove-btn" onClick={onRemove}>Remove</button>
        <div className="form-group">
          <label>Predictor Variable</label>
          <input
            type="text"
            value={data.variable}
            onChange={(e) => onUpdate('variable', e.target.value)}
            className="form-control"
            placeholder="e.g., Age, GCS, Hydrocephalus"
          />
        </div>
        <div className="grid-3col">
          <div className="form-group">
            <label>Effect Size (OR/HR)</label>
            <input
              type="number"
              step="0.01"
              value={data.effectSize}
              onChange={(e) => onUpdate('effectSize', e.target.value)}
              className="form-control"
            />
          </div>
          <div className="form-group">
            <label>95% CI (Lower)</label>
            <input
              type="number"
              step="0.01"
              value={data.ciLower}
              onChange={(e) => onUpdate('ciLower', e.target.value)}
              className="form-control"
            />
          </div>
          <div className="form-group">
            <label>95% CI (Upper)</label>
            <input
              type="number"
              step="0.01"
              value={data.ciUpper}
              onChange={(e) => onUpdate('ciUpper', e.target.value)}
              className="form-control"
            />
          </div>
        </div>
        <div className="form-group">
          <label>p-Value</label>
          <input
            type="number"
            step="0.001"
            value={data.pValue}
            onChange={(e) => onUpdate('pValue', e.target.value)}
            className="form-control"
          />
        </div>
      </div>
    );

    // Detailed Extraction Panel - Main container for all dynamic fields
    const DetailedExtractionPanel = ({
      indications, interventions, studyArms, mortalityData, mrsData, complications, predictors,
      onAddIndication, onAddIntervention, onAddArm, onAddMortality, onAddMRS, onAddComplication, onAddPredictor,
      onUpdateField, onRemoveField
    }) => {
      return (
        <div style={{ padding: '20px', overflowY: 'auto', height: '100%', background: '#f8f9fa' }}>
          <h2 style={{ marginBottom: '24px', color: '#2c3e50' }}>Detailed Extraction</h2>
          <p style={{ marginBottom: '32px', color: '#666', fontSize: '14px' }}>
            Capture comprehensive study data with dynamic fields for indications, interventions, study arms, outcomes, and statistical analyses.
          </p>

          {/* Study Arms Section (CRITICAL: Must come first for linked selectors) */}
          <div className="field-section">
            <h3>üìä Study Arms</h3>
            <p className="field-section-description">
              Define treatment groups. These arms will automatically appear in mortality, mRS, and complication selectors.
            </p>
            <button className="add-field-btn" onClick={onAddArm}>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 5v14m-7-7h14" />
              </svg>
              Add Study Arm
            </button>
            {studyArms.length === 0 ? (
              <div className="empty-state">Add your first study arm to enable arm-specific data collection</div>
            ) : (
              studyArms.map((arm, i) => (
                <StudyArmField
                  key={arm.id}
                  data={arm}
                  index={i}
                  onUpdate={(field, value) => onUpdateField('arm', arm.id, field, value)}
                  onRemove={() => onRemoveField('arm', arm.id)}
                />
              ))
            )}
          </div>

          {/* Indications Section */}
          <div className="field-section">
            <h3>üè• Indications for Surgery</h3>
            <p className="field-section-description">Signs and symptoms that indicated need for surgical intervention.</p>
            <button className="add-field-btn" onClick={onAddIndication}>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 5v14m-7-7h14" />
              </svg>
              Add Indication
            </button>
            {indications.length === 0 ? (
              <div className="empty-state">No indications added yet</div>
            ) : (
              indications.map((indication, i) => (
                <IndicationField
                  key={indication.id}
                  data={indication}
                  index={i}
                  onUpdate={(field, value) => onUpdateField('indication', indication.id, field, value)}
                  onRemove={() => onRemoveField('indication', indication.id)}
                />
              ))
            )}
          </div>

          {/* Interventions Section */}
          <div className="field-section">
            <h3>‚öïÔ∏è Interventions</h3>
            <p className="field-section-description">Surgical procedures and intervention details.</p>
            <button className="add-field-btn" onClick={onAddIntervention}>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 5v14m-7-7h14" />
              </svg>
              Add Intervention
            </button>
            {interventions.length === 0 ? (
              <div className="empty-state">No interventions added yet</div>
            ) : (
              interventions.map((intervention, i) => (
                <InterventionField
                  key={intervention.id}
                  data={intervention}
                  index={i}
                  onUpdate={(field, value) => onUpdateField('intervention', intervention.id, field, value)}
                  onRemove={() => onRemoveField('intervention', intervention.id)}
                />
              ))
            )}
          </div>

          {/* Mortality Section */}
          <div className="field-section">
            <h3>üíÄ Mortality Data</h3>
            <p className="field-section-description">Mortality outcomes by study arm and timepoint.</p>
            <button className="add-field-btn" onClick={onAddMortality}>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 5v14m-7-7h14" />
              </svg>
              Add Mortality Data Point
            </button>
            {mortalityData.length === 0 ? (
              <div className="empty-state">No mortality data added yet. Add study arms first to enable arm selection.</div>
            ) : (
              mortalityData.map((mortality, i) => (
                <MortalityField
                  key={mortality.id}
                  data={mortality}
                  index={i}
                  availableArms={studyArms.filter(arm => arm.label.trim())}
                  onUpdate={(field, value) => onUpdateField('mortality', mortality.id, field, value)}
                  onRemove={() => onRemoveField('mortality', mortality.id)}
                />
              ))
            )}
          </div>

          {/* mRS Section */}
          <div className="field-section">
            <h3>üìà mRS Distribution</h3>
            <p className="field-section-description">Modified Rankin Scale outcomes with full 0-6 score distribution.</p>
            <button className="add-field-btn" onClick={onAddMRS}>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 5v14m-7-7h14" />
              </svg>
              Add mRS Data Point
            </button>
            {mrsData.length === 0 ? (
              <div className="empty-state">No mRS data added yet. Add study arms first to enable arm selection.</div>
            ) : (
              mrsData.map((mrs, i) => (
                <MRSField
                  key={mrs.id}
                  data={mrs}
                  index={i}
                  availableArms={studyArms.filter(arm => arm.label.trim())}
                  onUpdate={(field, value) => onUpdateField('mrs', mrs.id, field, value)}
                  onRemove={() => onRemoveField('mrs', mrs.id)}
                />
              ))
            )}
          </div>

          {/* Complications Section */}
          <div className="field-section">
            <h3>‚ö†Ô∏è Complications</h3>
            <p className="field-section-description">Adverse events and complications by study arm.</p>
            <button className="add-field-btn" onClick={onAddComplication}>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 5v14m-7-7h14" />
              </svg>
              Add Complication
            </button>
            {complications.length === 0 ? (
              <div className="empty-state">No complications added yet. Add study arms first to enable arm selection.</div>
            ) : (
              complications.map((complication, i) => (
                <ComplicationField
                  key={complication.id}
                  data={complication}
                  index={i}
                  availableArms={studyArms.filter(arm => arm.label.trim())}
                  onUpdate={(field, value) => onUpdateField('complication', complication.id, field, value)}
                  onRemove={() => onRemoveField('complication', complication.id)}
                />
              ))
            )}
          </div>

          {/* Predictors Section */}
          <div className="field-section">
            <h3>üìä Predictor Analyses</h3>
            <p className="field-section-description">Statistical predictors with effect sizes and confidence intervals.</p>
            <button className="add-field-btn" onClick={onAddPredictor}>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 5v14m-7-7h14" />
              </svg>
              Add Predictor
            </button>
            {predictors.length === 0 ? (
              <div className="empty-state">No predictors added yet</div>
            ) : (
              predictors.map((predictor, i) => (
                <PredictorField
                  key={predictor.id}
                  data={predictor}
                  index={i}
                  onUpdate={(field, value) => onUpdateField('predictor', predictor.id, field, value)}
                  onRemove={() => onRemoveField('predictor', predictor.id)}
                />
              ))
            )}
          </div>
        </div>
      );
    };

    function App() {
      // PDF State
      const [pdfFile, setPdfFile] = useState(null);
      const [pdfDoc, setPdfDoc] = useState(null);
      const [pageNum, setPageNum] = useState(1);
      const [numPages, setNumPages] = useState(0);
      const [pageOneText, setPageOneText] = useState('');

      // Extraction State
      const [highlights, setHighlights] = useState([]);
      const [currentField, setCurrentField] = useState('');
      const [selectionMode, setSelectionMode] = useState(false);
      const [aiFilledFields, setAiFilledFields] = useState(new Set());

      // Citation State (from Claude Native Citations)
      const [citations, setCitations] = useState([]);
      const [activeCitation, setActiveCitation] = useState(null);
      const [citationHighlights, setCitationHighlights] = useState([]);

      // Firebase State
      const [user, setUser] = useState(null);
      const [saving, setSaving] = useState(false);

      const [extractedData, setExtractedData] = useState({
        study_id: '', authors: '', year: '', title: '',
        population: { sample_size: '', mean_age: '', diagnosis: 'Space-occupying cerebellar infarction', inclusion_criteria: '' },
        intervention: { procedure: '', timing_hours: '', technique: '', additional_details: '' },
        comparator: '',
        outcomes: { mortality: '', mRS_favorable: '', complications: '', length_of_stay: '' },
        timing: { follow_up_duration: '' },
        study_design: '', newcastle_ottawa_score: ''
      });

      // UI State
      const [toast, setToast] = useState(null);
      const [isLoading, setIsLoading] = useState(false);
      const [activeTab, setActiveTab] = useState('extract'); // 'extract', 'chat', or 'detailed'
      const [chatMessages, setChatMessages] = useState([]); // Array of {role, text}

      // Detailed Extraction State (7 dynamic field types)
      const [indications, setIndications] = useState([]);
      const [interventions, setInterventions] = useState([]);
      const [studyArms, setStudyArms] = useState([]);
      const [mortalityData, setMortalityData] = useState([]);
      const [mrsData, setMrsData] = useState([]);
      const [complications, setComplications] = useState([]);
      const [predictors, setPredictors] = useState([]);

      // Counters for generating unique IDs
      const counterRef = useRef({
        indication: 0,
        intervention: 0,
        arm: 0,
        mortality: 0,
        mrs: 0,
        complication: 0,
        predictor: 0
      });

      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      // --- DYNAMIC FIELD MANAGEMENT ---
      // Add field handlers
      const addIndication = () => {
        const id = counterRef.current.indication++;
        setIndications(prev => [...prev, {
          id,
          sign: '',
          count: ''
        }]);
      };

      const addIntervention = () => {
        const id = counterRef.current.intervention++;
        setInterventions(prev => [...prev, {
          id,
          type: '',
          timeToSurgery: '',
          duraplasty: 'null'
        }]);
      };

      const addStudyArm = () => {
        const id = counterRef.current.arm++;
        setStudyArms(prev => [...prev, {
          id,
          label: '',
          sampleSize: ''
        }]);
      };

      const addMortality = () => {
        const id = counterRef.current.mortality++;
        setMortalityData(prev => [...prev, {
          id,
          arm: '',
          timepoint: '',
          deaths: '',
          total: ''
        }]);
      };

      const addMRS = () => {
        const id = counterRef.current.mrs++;
        setMrsData(prev => [...prev, {
          id,
          arm: '',
          timepoint: '',
          scores: { 0: '', 1: '', 2: '', 3: '', 4: '', 5: '', 6: '' }
        }]);
      };

      const addComplication = () => {
        const id = counterRef.current.complication++;
        setComplications(prev => [...prev, {
          id,
          description: '',
          arm: '',
          count: ''
        }]);
      };

      const addPredictor = () => {
        const id = counterRef.current.predictor++;
        setPredictors(prev => [...prev, {
          id,
          variable: '',
          effectSize: '',
          ciLower: '',
          ciUpper: '',
          pValue: ''
        }]);
      };

      // Remove field handlers
      const removeField = (type, id) => {
        switch (type) {
          case 'indication':
            setIndications(prev => prev.filter(item => item.id !== id));
            break;
          case 'intervention':
            setInterventions(prev => prev.filter(item => item.id !== id));
            break;
          case 'arm':
            setStudyArms(prev => prev.filter(item => item.id !== id));
            break;
          case 'mortality':
            setMortalityData(prev => prev.filter(item => item.id !== id));
            break;
          case 'mrs':
            setMrsData(prev => prev.filter(item => item.id !== id));
            break;
          case 'complication':
            setComplications(prev => prev.filter(item => item.id !== id));
            break;
          case 'predictor':
            setPredictors(prev => prev.filter(item => item.id !== id));
            break;
        }
      };

      // Update field value handlers
      const updateField = (type, id, field, value) => {
        switch (type) {
          case 'indication':
            setIndications(prev => prev.map(item =>
              item.id === id ? { ...item, [field]: value } : item
            ));
            break;
          case 'intervention':
            setInterventions(prev => prev.map(item =>
              item.id === id ? { ...item, [field]: value } : item
            ));
            break;
          case 'arm':
            setStudyArms(prev => prev.map(item =>
              item.id === id ? { ...item, [field]: value } : item
            ));
            break;
          case 'mortality':
            setMortalityData(prev => prev.map(item =>
              item.id === id ? { ...item, [field]: value } : item
            ));
            break;
          case 'mrs':
            if (field.startsWith('score_')) {
              const scoreNum = field.split('_')[1];
              setMrsData(prev => prev.map(item =>
                item.id === id ? {
                  ...item,
                  scores: { ...item.scores, [scoreNum]: value }
                } : item
              ));
            } else {
              setMrsData(prev => prev.map(item =>
                item.id === id ? { ...item, [field]: value } : item
              ));
            }
            break;
          case 'complication':
            setComplications(prev => prev.map(item =>
              item.id === id ? { ...item, [field]: value } : item
            ));
            break;
          case 'predictor':
            setPredictors(prev => prev.map(item =>
              item.id === id ? { ...item, [field]: value } : item
            ));
            break;
        }
      };

      // --- FIREBASE AUTH ---
      const signInWithGoogle = async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await auth.signInWithPopup(provider);
          analytics.logEvent('login', { method: 'google' });
          showToast("Signed in successfully!");
        } catch (error) {
          console.error("Auth Error:", error);
          showToast("Sign in failed", "error");
        }
      };

      const signOut = () => {
        auth.signOut();
        showToast("Signed out");
      };

      useEffect(() => {
        if (!auth) return;
        const unsubscribe = auth.onAuthStateChanged(user => {
          setUser(user);
          if (!user) {
            // Optional: Auto-signin anonymously if you want to allow guest access
            // auth.signInAnonymously().catch(console.error);
          }
        });
        return unsubscribe;
      }, []);

      // --- FIREBASE SYNC ---
      // 1. Load initial data
      useEffect(() => {
        if (!user || !db) return;
        const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('data').doc('current_extraction');

        // Initial Load
        docRef.get().then(doc => {
          if (doc.exists) {
            const data = doc.data();
            if (data.extractedData) {
              setExtractedData(data.extractedData);
              setAiFilledFields(new Set(data.aiFilledFields || []));
              setHighlights(data.highlights || []);
              showToast("Cloud data loaded");
            }
          }
        }).catch(console.error);

        return () => { };
      }, [user]);

      // 2. Auto-save on change (Debounced)
      useEffect(() => {
        if (!user || !db) return;
        const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('data').doc('current_extraction');

        setSaving(true);
        const handler = setTimeout(() => {
          docRef.set({
            extractedData,
            highlights,
            aiFilledFields: Array.from(aiFilledFields),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true }).then(() => {
            setSaving(false);
          }).catch(err => {
            console.error("Save failed", err);
            setSaving(false);
          });
        }, 1000);

        return () => clearTimeout(handler);
      }, [extractedData, highlights, user, aiFilledFields]);


      const handleFileUpload = async (file) => {
        if (!file) return;
        setIsLoading(true);
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const arrayBuffer = e.target.result;
            setPdfFile(file.name);
            setPdfDoc(null);
            setChatMessages([{ role: 'system', text: 'Document loaded. You can now chat with the abstract.' }]);

            const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
            const pdf = await loadingTask.promise;
            setPdfDoc(pdf);
            setNumPages(pdf.numPages);
            setPageNum(1);

            try {
              const page = await pdf.getPage(1);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(' ');
              setPageOneText(pageText);
            } catch (err) { console.error("Text extraction warning", err); }

            showToast("PDF loaded successfully");
            analytics.logEvent('pdf_uploaded', { file_name: file.name, num_pages: pdf.numPages });
          } catch (error) {
            showToast("Error loading PDF", 'error');
            console.error(error);
          } finally {
            setIsLoading(false);
          }
        };
        reader.readAsArrayBuffer(file);
      };

      const updateField = (path, value, isAi = false) => {
        const keys = path.split('.');
        setExtractedData(prev => {
          const next = JSON.parse(JSON.stringify(prev));
          let current = next;
          for (let i = 0; i < keys.length - 1; i++) current = current[keys[i]];
          current[keys[keys.length - 1]] = value;
          return next;
        });

        if (isAi) {
          setAiFilledFields(prev => new Set(prev).add(path));
        } else {
          const newSet = new Set(aiFilledFields);
          newSet.delete(path);
          setAiFilledFields(newSet);
        }
      };

      // --- FEATURE 0: CLAUDE CITATION EXTRACTION ---
      const handleClaudeCitationExtract = async () => {
        if (!pdfDoc) return showToast("No PDF loaded", "error");
        setIsLoading(true);

        try {
          // Extract full text with positions
          const positions = await extractPdfPositions(pdfDoc);
          const fullText = positions.map(p => p.text).join(' ');

          showToast("Extracting with Claude citations...");

          const result = await callClaudeWithCitations(fullText, positions);

          if (result && result.success) {
            // Set citations for display
            setCitations(result.citations || []);
            setCitationHighlights(result.citations || []);

            showToast(`‚ú® Found ${result.citations?.length || 0} verified citations!`);
            analytics.logEvent('claude_citation_extraction', { citationCount: result.citations?.length || 0 });
          } else {
            showToast("Citation extraction unavailable, using Gemini fallback", "error");
            // Fall back to Gemini
            await handleAiAutofill();
          }
        } catch (e) {
          console.error('Citation extraction error:', e);
          showToast("Citation extraction failed", "error");
        } finally {
          setIsLoading(false);
        }
      };

      // --- FEATURE 1: AUTO-FILL ENTIRE FORM ---
      const handleAiAutofill = async () => {
        if (!pageOneText) return showToast("No text available from abstract", "error");
        setIsLoading(true);

        const systemPrompt = `You are an expert systematic reviewer. Extract data from this medical study abstract into the exact JSON structure provided. 
                              Be precise. If data is missing, use empty strings. 
                              Return ONLY valid JSON. 
                              
                              Abstract: ${pageOneText}`;

        try {
          const jsonText = await callGemini(systemPrompt, GEMINI_SCHEMA);
          if (!jsonText) throw new Error("No data returned");

          const aiData = JSON.parse(jsonText);
          const newAiFields = new Set(aiFilledFields);

          setExtractedData(prev => {
            const next = JSON.parse(JSON.stringify(prev));

            const safeUpdate = (obj, targetObj, prefix) => {
              Object.keys(obj).forEach(k => {
                if (typeof obj[k] === 'object' && obj[k] !== null) {
                  safeUpdate(obj[k], targetObj[k], prefix ? `${prefix}.${k}` : k);
                } else if (obj[k] && targetObj.hasOwnProperty(k)) {
                  targetObj[k] = obj[k];
                  newAiFields.add(prefix ? `${prefix}.${k}` : k);
                }
              });
            }

            // Map specific top level fields manually to be safe
            if (aiData.study_id) { next.study_id = aiData.study_id; newAiFields.add('study_id'); }
            if (aiData.authors) { next.authors = aiData.authors; newAiFields.add('authors'); }
            if (aiData.year) { next.year = aiData.year; newAiFields.add('year'); }
            if (aiData.title) { next.title = aiData.title; newAiFields.add('title'); }
            if (aiData.study_design) { next.study_design = aiData.study_design; newAiFields.add('study_design'); }

            // Map nested
            if (aiData.population) safeUpdate(aiData.population, next.population, 'population');
            if (aiData.intervention) safeUpdate(aiData.intervention, next.intervention, 'intervention');
            if (aiData.outcomes) safeUpdate(aiData.outcomes, next.outcomes, 'outcomes');

            return next;
          });

          setAiFilledFields(newAiFields);
          showToast("‚ú® Data extracted from abstract!");
          analytics.logEvent('ai_extraction_completed');
        } catch (e) {
          console.error(e);
          showToast("AI Extraction failed", "error");
        } finally {
          setIsLoading(false);
        }
      };

      // --- FEATURE 2: SMART FIELD SUGGEST ---
      const handleSmartSuggest = async (fieldLabel, path) => {
        if (!pageOneText) return showToast("No text available", "error");

        const prompt = `Context: ${pageOneText}
          
          Task: Identify and extract the "${fieldLabel}" from the medical study abstract above.
          Return ONLY the extracted value as a plain text string. Do not include label names or markdown. 
          If not found, return "Not found".`;

        try {
          const result = await callGemini(prompt);
          if (result && !result.toLowerCase().includes("not found")) {
            updateField(path, result.trim(), true);
            showToast(`‚ú® Found ${fieldLabel}`);
          } else {
            showToast(`Could not find ${fieldLabel}`, "error");
          }
        } catch (e) {
          console.error(e);
          showToast("Suggestion failed", "error");
        }
      };

      // --- FEATURE 3: CHAT ASSISTANT ---
      const handleSendMessage = async (text) => {
        if (!text.trim()) return;

        const newMessage = { role: 'user', text };
        setChatMessages(prev => [...prev, newMessage]);

        if (!pageOneText) {
          setChatMessages(prev => [...prev, { role: 'assistant', text: 'Please upload a PDF with extractable text first.' }]);
          return;
        }

        const prompt = `Context (Abstract of a medical study):
          ${pageOneText}
          
          User Question: ${text}
          
          Answer as a helpful medical research assistant. Keep it concise and grounded in the context provided.`;

        try {
          const response = await callGemini(prompt);
          setChatMessages(prev => [...prev, { role: 'assistant', text: response }]);
        } catch (e) {
          setChatMessages(prev => [...prev, { role: 'assistant', text: 'Sorry, I encountered an error processing your request.' }]);
        }
      };

      // --- FEATURE 4: QUALITY CHECK ---
      const handleQualityCheck = async () => {
        if (!pageOneText) return showToast("No text available", "error");
        setIsLoading(true);

        const prompt = `Context: ${pageOneText}
          
          Task: Evaluate the risk of bias and quality of this study based on the abstract. 
          1. Identify the study design (e.g. RCT, Cohort).
          2. Estimate a Newcastle-Ottawa Score (0-9) if observational, or Jadad Score (0-5) if RCT.
          3. Return a short 1-sentence reasoning.
          
          Return Format: "Score: X/9 (Reasoning...)"`;

        try {
          const result = await callGemini(prompt);
          updateField('newcastle_ottawa_score', result);
          showToast("‚ú® Quality assessed!");
        } catch (e) {
          showToast("Assessment failed", "error");
        } finally {
          setIsLoading(false);
        }
      };

      // --- FEATURE 5: CITATION GENERATOR ---
      const handleGenerateCitation = async () => {
        if (!extractedData.title && !pageOneText) return showToast("No title or text available", "error");
        setIsLoading(true);

        const context = extractedData.title ? `Title: ${extractedData.title}, Authors: ${extractedData.authors}, Year: ${extractedData.year}` : `Abstract: ${pageOneText}`;

        const prompt = `Generate a citation in APA 7th format for this study based on the following info: ${context}. Return ONLY the citation string.`;

        try {
          const result = await callGemini(prompt);
          // Just appending it to the chat for now as a useful place to show it
          setChatMessages(prev => [...prev, { role: 'assistant', text: `üìù Generated Citation:\n${result}` }]);
          setActiveTab('chat');
          showToast("Citation generated in Chat!");
        } catch (e) {
          showToast("Citation generation failed", "error");
        } finally {
          setIsLoading(false);
        }
      };

      const addHighlight = (rect, rawText) => {
        const text = cleanExtractedText(rawText);
        const highlight = {
          id: Date.now(),
          page: pageNum,
          field: currentField,
          rect: rect,
          text: text
        };
        setHighlights([...highlights, highlight]);

        const dataPath = FIELD_MAP[currentField];
        if (dataPath) {
          const keys = dataPath.split('.');
          let currentVal = extractedData;
          keys.forEach(k => currentVal = currentVal[k]);
          const newValue = currentVal ? `${currentVal}; ${text}` : text;
          updateField(dataPath, newValue);
          showToast(`Captured: ${currentField}`);
        }
        setSelectionMode(false);
      };

      const handleExport = () => {
        const blob = new Blob([JSON.stringify(extractedData, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${extractedData.study_id || 'data'}.json`;
        a.click();
        analytics.logEvent('data_exported', { study_id: extractedData.study_id });
      };

      if (!user) {
        return (
          <div style={{ display: 'flex', height: '100vh', justifyContent: 'center', alignItems: 'center', background: '#eef2f5' }}>
            <div style={{ padding: 40, background: 'white', borderRadius: 8, boxShadow: '0 4px 12px rgba(0,0,0,0.1)', textAlign: 'center' }}>
              <h2 style={{ marginBottom: 20, color: '#2c3e50' }}>Cerebellar Extraction Tool</h2>
              <p style={{ marginBottom: 30, color: '#7f8c8d' }}>Please sign in to access your extractions.</p>
              <button onClick={signInWithGoogle} style={{ padding: '12px 24px', background: '#4285F4', color: 'white', border: 'none', borderRadius: 4, cursor: 'pointer', fontWeight: 600, fontSize: 16 }}>
                Sign in with Google
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="app">
          {isLoading && <div className="loading-overlay"><div className="spinner"></div></div>}

          <div style={{ position: 'absolute', top: 10, right: 10, zIndex: 1000 }}>
            <button onClick={signOut} style={{ padding: '6px 12px', background: '#e74c3c', color: 'white', border: 'none', borderRadius: 4, cursor: 'pointer', fontSize: 12 }}>
              Sign Out
            </button>
          </div>

          <PDFPanel
            pdfFile={pdfFile}
            pdfDoc={pdfDoc}
            pageNum={pageNum}
            numPages={numPages}
            highlights={highlights}
            currentField={currentField}
            selectionMode={selectionMode}
            onFileUpload={handleFileUpload}
            onPageChange={setPageNum}
            onFieldSelect={setCurrentField}
            onSelectionModeToggle={setSelectionMode}
            onAddHighlight={addHighlight}
            citationHighlights={citationHighlights}
            activeCitation={activeCitation}
            onCitationClick={(cit) => {
              setActiveCitation(cit);
              if (cit.page !== pageNum) setPageNum(cit.page);
            }}
          />

          <div className="extraction-panel">
            <div className="extraction-header">
              <div className="header-title-row">
                <h2>üìã Extraction Assistant</h2>
                {saving ? (
                  <span className="save-status saving"><Icons.Cloud size={12} /> Saving...</span>
                ) : (
                  <span className="save-status saved"><Icons.Check size={12} /> Saved</span>
                )}
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10, gap: 8 }}>
                {activeTab === 'extract' && (
                  <>
                    <button
                      className="btn-ai-magic"
                      onClick={handleClaudeCitationExtract}
                      disabled={!pdfDoc}
                      style={{ background: 'linear-gradient(135deg, #6366f1, #8b5cf6)' }}
                      title="Extract with verified source citations"
                    >
                      <Icons.Quote size={12} /> Citations
                    </button>
                    <button className="btn-ai-magic" onClick={handleAiAutofill} disabled={!pageOneText}>
                      <Icons.Wand2 size={12} /> Auto-Fill
                    </button>
                  </>
                )}
              </div>
              <div className="panel-tabs">
                <button className={`tab-btn ${activeTab === 'extract' ? 'active' : ''}`} onClick={() => setActiveTab('extract')}>
                  <Icons.FileText size={14} style={{ marginRight: 4, display: 'inline', verticalAlign: 'middle' }} /> Form
                </button>
                <button className={`tab-btn ${activeTab === 'detailed' ? 'active' : ''}`} onClick={() => setActiveTab('detailed')}>
                  <Icons.Database size={14} style={{ marginRight: 4, display: 'inline', verticalAlign: 'middle' }} /> Detailed
                </button>
                <button className={`tab-btn ${activeTab === 'chat' ? 'active' : ''}`} onClick={() => setActiveTab('chat')}>
                  <Icons.MessageSquare size={14} style={{ marginRight: 4, display: 'inline', verticalAlign: 'middle' }} /> Chat with Paper
                </button>
              </div>
            </div>

            <div className="extraction-content">
              {activeTab === 'extract' ? (
                <ExtractionForm
                  data={extractedData}
                  highlights={highlights}
                  currentField={currentField}
                  aiFilledFields={aiFilledFields}
                  onUpdate={updateField}
                  onFieldSelect={setCurrentField}
                  onExport={handleExport}
                  onGoToHighlight={setPageNum}
                  onSmartSuggest={handleSmartSuggest}
                  onQualityCheck={handleQualityCheck}
                  onGenerateCitation={handleGenerateCitation}
                  citations={citations}
                  activeCitation={activeCitation}
                  onCitationSelect={(cit) => {
                    setActiveCitation(cit);
                    if (cit.page) setPageNum(cit.page);
                  }}
                />
              ) : activeTab === 'detailed' ? (
                <DetailedExtractionPanel
                  indications={indications}
                  interventions={interventions}
                  studyArms={studyArms}
                  mortalityData={mortalityData}
                  mrsData={mrsData}
                  complications={complications}
                  predictors={predictors}
                  onAddIndication={addIndication}
                  onAddIntervention={addIntervention}
                  onAddArm={addStudyArm}
                  onAddMortality={addMortality}
                  onAddMRS={addMRS}
                  onAddComplication={addComplication}
                  onAddPredictor={addPredictor}
                  onUpdateField={updateField}
                  onRemoveField={removeField}
                />
              ) : (
                <ChatInterface
                  messages={chatMessages}
                  onSendMessage={handleSendMessage}
                  hasContext={!!pageOneText}
                />
              )}
            </div>
          </div>

          {toast && <div className={`toast ${toast.type}`}>{toast.message}</div>}
        </div>
      );
    }

    // --- SUB-COMPONENTS ---

    function ChatInterface({ messages, onSendMessage, hasContext }) {
      const [input, setInput] = useState('');
      const msgEndRef = useRef(null);

      const send = (e) => {
        e.preventDefault();
        if (input.trim()) {
          onSendMessage(input);
          setInput('');
        }
      };

      const handleQuickPrompt = (text) => {
        onSendMessage(text);
      };

      useEffect(() => {
        msgEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      return (
        <div className="chat-container">
          <div className="chat-messages">
            {messages.map((m, i) => (
              <div key={i} className={`message ${m.role}`}>
                {m.role === 'assistant' && <div style={{ fontWeight: 'bold', marginBottom: 4, fontSize: 11, color: '#8e44ad' }}>GEMINI</div>}
                {m.text}
              </div>
            ))}
            <div ref={msgEndRef} />
          </div>

          {hasContext && (
            <div className="quick-prompts">
              {QUICK_PROMPTS.map(p => (
                <button key={p} className="prompt-pill" onClick={() => handleQuickPrompt(p)}>
                  {p}
                </button>
              ))}
            </div>
          )}

          <form className="chat-input-area" onSubmit={send}>
            <input
              className="chat-input"
              placeholder={hasContext ? "Ask about the paper..." : "Upload a PDF first..."}
              value={input}
              onChange={e => setInput(e.target.value)}
              disabled={!hasContext}
            />
            <button type="submit" className="btn-send" disabled={!hasContext}>
              <Icons.Send size={16} />
            </button>
          </form>
        </div>
      );
    }

    function ExtractionForm({ data, highlights, currentField, aiFilledFields, onUpdate, onFieldSelect, onExport, onGoToHighlight, onSmartSuggest, onQualityCheck, onGenerateCitation, citations, activeCitation, onCitationSelect }) {
      const currentPath = FIELD_MAP[currentField];
      const [collapsed, setCollapsed] = useState({ pop: false, int: false, out: false, meta: false, cit: false });
      const toggle = (sec) => setCollapsed(prev => ({ ...prev, [sec]: !prev[sec] }));

      const Input = ({ label, path, type = "text", rows }) => {
        const val = path.split('.').reduce((o, i) => o[i], data);
        const isAi = aiFilledFields.has(path);
        const isFocused = currentPath === path;
        const [isSuggesting, setIsSuggesting] = useState(false);

        const triggerSuggest = async () => {
          setIsSuggesting(true);
          await onSmartSuggest(label, path);
          setIsSuggesting(false);
        };

        return (
          <div className="form-group">
            <label>{label}</label>
            <div className="input-wrapper">
              {rows ? (
                <textarea className={`form-control ${isAi ? 'ai-filled' : ''} ${isFocused ? 'field-focused' : ''}`}
                  value={val} onChange={e => onUpdate(path, e.target.value)}
                  onFocus={() => onFieldSelect(Object.keys(FIELD_MAP).find(key => FIELD_MAP[key] === path))} rows={rows} />
              ) : (
                <input className={`form-control ${isAi ? 'ai-filled' : ''} ${isFocused ? 'field-focused' : ''}`}
                  type={type} value={val} onChange={e => onUpdate(path, e.target.value)}
                  onFocus={() => onFieldSelect(Object.keys(FIELD_MAP).find(key => FIELD_MAP[key] === path))} />
              )}
              <div className="input-actions">
                <button className={`btn-suggest ${isSuggesting ? 'loading' : ''}`}
                  onClick={triggerSuggest} title="Ask Gemini to find this" type="button">
                  <Icons.Wand2 size={14} />
                </button>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="extraction-form-container">
          <div className="form-section">
            <div className="section-header" onClick={() => toggle('meta')}>
              <div className="section-title">üÜî Study Identification</div>
              <Icons.ChevronDown size={16} style={{ transform: collapsed.meta ? 'rotate(-90deg)' : '' }} />
            </div>
            <div className={`section-body ${collapsed.meta ? 'collapsed' : ''}`}>
              <div style={{ display: 'flex', alignItems: 'center', marginBottom: 10 }}>
                <button className="btn-quality-check" onClick={onGenerateCitation} style={{ marginLeft: 0 }}>
                  <Icons.Quote size={12} /> Generate Citation
                </button>
              </div>
              <Input label="Study ID" path="study_id" />
              <Input label="Authors" path="authors" />
              <div style={{ display: 'flex', gap: '10px' }}>
                <div style={{ flex: 1 }}><Input label="Year" path="year" /></div>
                <div style={{ flex: 2 }}><Input label="Design" path="study_design" /></div>
              </div>
              <Input label="Title" path="title" />
            </div>
          </div>

          <div className="form-section">
            <div className="section-header" onClick={() => toggle('pop')}>
              <div className="section-title">üë• Population</div>
            </div>
            <div className={`section-body ${collapsed.pop ? 'collapsed' : ''}`}>
              <div style={{ display: 'flex', gap: '10px' }}>
                <div style={{ flex: 1 }}><Input label="Sample Size" path="population.sample_size" /></div>
                <div style={{ flex: 1 }}><Input label="Mean Age" path="population.mean_age" /></div>
              </div>
              <Input label="Inclusion Criteria" path="population.inclusion_criteria" rows={3} />
            </div>
          </div>

          <div className="form-section">
            <div className="section-header" onClick={() => toggle('int')}>
              <div className="section-title">üíâ Intervention</div>
            </div>
            <div className={`section-body ${collapsed.int ? 'collapsed' : ''}`}>
              <Input label="Procedure" path="intervention.procedure" />
              <Input label="Timing (Hours)" path="intervention.timing_hours" />
              <Input label="Technique" path="intervention.technique" rows={2} />
              <Input label="Comparator" path="comparator" />
            </div>
          </div>

          <div className="form-section">
            <div className="section-header" onClick={() => toggle('out')}>
              <div className="section-title">üìâ Outcomes</div>
            </div>
            <div className={`section-body ${collapsed.out ? 'collapsed' : ''}`}>
              <div style={{ display: 'flex', gap: '10px' }}>
                <div style={{ flex: 1 }}><Input label="Mortality" path="outcomes.mortality" /></div>
                <div style={{ flex: 1 }}><Input label="Favorable Outcome" path="outcomes.mRS_favorable" /></div>
              </div>
              <Input label="Complications" path="outcomes.complications" rows={3} />
              <Input label="Length of Stay" path="outcomes.length_of_stay" />

              <div style={{ marginTop: 15, paddingTop: 15, borderTop: '1px dashed #eee' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 5 }}>
                  <label style={{ fontSize: 12, fontWeight: 600, color: '#7f8c8d', textTransform: 'uppercase' }}>Quality Score</label>
                  <button className="btn-quality-check" onClick={onQualityCheck}>
                    <Icons.Activity size={12} /> Analyze Quality
                  </button>
                </div>
                <Input label="" path="newcastle_ottawa_score" />
              </div>
            </div>
          </div>

          {/* Citation Provenance Panel */}
          {citations && citations.length > 0 && (
            <div className="citation-panel">
              <div className="citation-panel-header" onClick={() => toggle('cit')}>
                <span>üìé Verified Citations ({citations.length})</span>
                <Icons.ChevronDown size={16} style={{ marginLeft: 'auto', transform: collapsed.cit ? 'rotate(-90deg)' : '' }} />
              </div>
              {!collapsed.cit && citations.map((cit, idx) => (
                <div
                  key={cit.id || idx}
                  className={`citation-card ${activeCitation?.id === cit.id ? 'active' : ''}`}
                  onClick={() => onCitationSelect(cit)}
                >
                  <div className="citation-field">{cit.field || 'Extracted Value'}</div>
                  <div className="citation-value">{cit.value || cit.citedText?.substring(0, 60)}</div>
                  <div className="citation-source">
                    "{cit.sourceText || cit.citedText}"
                  </div>
                  <div className="citation-meta">
                    <span>Page {cit.page}</span>
                    <span>Chars {cit.startChar}-{cit.endChar}</span>
                  </div>
                </div>
              ))}
            </div>
          )}

          {highlights.length > 0 && (
            <div className="annotations-container">
              <h3 style={{ fontSize: '12px', fontWeight: 600, color: '#777', marginBottom: '10px', marginTop: '20px' }}>CAPTURED SNIPPETS</h3>
              {highlights.map(h => (
                <div key={h.id} className="annotation-card" onClick={() => onGoToHighlight(h.page)}>
                  <strong>{h.field} (Pg {h.page})</strong>
                  <p>{h.text}</p>
                </div>
              ))}
            </div>
          )}

          <div className="panel-footer" style={{ marginTop: 20, padding: 0, borderTop: 'none' }}>
            <button className="action-btn btn-export-json" onClick={onExport}>Download JSON</button>
          </div>
        </div>
      );
    }

    function PDFPanel({
      pdfFile, pdfDoc, pageNum, numPages, highlights,
      currentField, selectionMode, onFileUpload, onPageChange,
      onFieldSelect, onSelectionModeToggle, onAddHighlight,
      citationHighlights, activeCitation, onCitationClick, onViewportChange
    }) {
      const canvasRef = useRef(null);
      const [scale, setScale] = useState(1.2);
      const [textContent, setTextContent] = useState(null);
      const [viewport, setViewport] = useState(null);

      useEffect(() => {
        if (pdfDoc) renderPage();
      }, [pdfDoc, pageNum, scale]);

      useEffect(() => {
        const canvas = canvasRef.current;
        if (!selectionMode || !canvas || !textContent) return;

        let startX, startY, isDrawing = false;
        let selectionBox = document.createElement('div');
        selectionBox.style.cssText = 'position:absolute; border: 2px dashed #f39c12; background: rgba(243, 156, 18, 0.2); pointer-events: none; z-index: 50;';

        const getCoords = (e) => {
          const rect = canvas.getBoundingClientRect();
          return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        };

        const onDown = (e) => {
          const { x, y } = getCoords(e);
          startX = x; startY = y;
          isDrawing = true;
          selectionBox.style.left = x + 'px'; selectionBox.style.top = y + 'px';
          canvas.parentElement.appendChild(selectionBox);
        };

        const onMove = (e) => {
          if (!isDrawing) return;
          const { x, y } = getCoords(e);
          const left = Math.min(startX, x), top = Math.min(startY, y);
          const width = Math.abs(x - startX), height = Math.abs(y - startY);
          selectionBox.style.left = left + 'px'; selectionBox.style.top = top + 'px';
          selectionBox.style.width = width + 'px'; selectionBox.style.height = height + 'px';
        };

        const onUp = (e) => {
          if (!isDrawing) return;
          isDrawing = false;
          const { x, y } = getCoords(e);
          selectionBox.remove();
          const rect = {
            left: Math.min(startX, x), top: Math.min(startY, y),
            width: Math.abs(x - startX), height: Math.abs(y - startY)
          };
          if (rect.width < 5 || rect.height < 5) return;
          onAddHighlight(rect, "Selected Text (Simulated Extraction)");
        };

        canvas.addEventListener('mousedown', onDown);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);

        return () => {
          canvas.removeEventListener('mousedown', onDown);
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
          if (selectionBox.parentNode) selectionBox.parentNode.removeChild(selectionBox);
        };
      }, [selectionMode, textContent]);

      const renderPage = async () => {
        try {
          const page = await pdfDoc.getPage(pageNum);
          const vp = page.getViewport({ scale });
          setViewport(vp);
          if (onViewportChange) onViewportChange(vp);

          const canvas = canvasRef.current;
          const ctx = canvas.getContext('2d');
          canvas.width = vp.width;
          canvas.height = vp.height;
          await page.render({ canvasContext: ctx, viewport: vp }).promise;
          const text = await page.getTextContent();
          setTextContent(text);
        } catch (e) { console.error(e); }
      };

      return (
        <div className="pdf-panel">
          <div className="pdf-header">
            <h2>üìÑ PDF Explorer</h2>
            <label className="file-upload-btn">
              Upload PDF
              <input type="file" accept=".pdf" onChange={e => onFileUpload(e.target.files[0])} />
            </label>
          </div>

          {pdfFile && (
            <div className="pdf-controls">
              <button className="control-btn" onClick={() => onPageChange(Math.max(1, pageNum - 1))} disabled={pageNum <= 1}>Previous</button>
              <span style={{ fontSize: '12px', margin: '0 10px' }}>Page {pageNum} / {numPages}</span>
              <button className="control-btn" onClick={() => onPageChange(Math.min(numPages, pageNum + 1))} disabled={pageNum >= numPages}>Next</button>
              <div style={{ width: '1px', height: '16px', background: '#666', margin: '0 10px' }}></div>
              <button className="control-btn" onClick={() => setScale(s => Math.max(0.5, s - 0.2))}>-</button>
              <span style={{ fontSize: '12px' }}>{Math.round(scale * 100)}%</span>
              <button className="control-btn" onClick={() => setScale(s => Math.min(3, s + 0.2))}>+</button>
            </div>
          )}

          <div className="annotation-bar">
            <select className="field-select" value={currentField} onChange={e => onFieldSelect(e.target.value)}>
              <option value="">-- Select Field to Extract --</option>
              {Object.keys(FIELD_MAP).map(k => <option key={k} value={k}>{k}</option>)}
            </select>

            <button
              className={`toggle-highlight-btn ${selectionMode ? 'active' : ''}`}
              onClick={() => onSelectionModeToggle(!selectionMode)}
              disabled={!currentField}
              title={!currentField ? "Select a field first" : "Click and drag on PDF"}
            >
              {selectionMode ? 'üñçÔ∏è Highlighting...' : 'Enable Selection'}
            </button>
          </div>

          <div className="pdf-viewer-container">
            {pdfFile ? (
              <div className="pdf-canvas-wrapper">
                <canvas ref={canvasRef} id="pdf-canvas" style={{ cursor: selectionMode ? 'crosshair' : 'default' }} />
                <div className="highlight-layer">
                  {/* Manual selection highlights (yellow) */}
                  {highlights.filter(h => h.page === pageNum).map(h => (
                    <div key={h.id} className="highlight"
                      style={{ left: h.rect.left, top: h.rect.top, width: h.rect.width, height: h.rect.height }}
                      title={h.field + ": " + h.text} />
                  ))}

                  {/* Claude citation highlights (purple) */}
                  {viewport && citationHighlights && citationHighlights
                    .filter(c => c.page === pageNum)
                    .map((c, idx) => {
                      const rect = pdfToCanvasCoords(c.x, c.y, c.width, c.height, viewport);
                      const isActive = activeCitation && activeCitation.id === c.id;
                      return (
                        <div
                          key={`cit-${idx}-${c.page}`}
                          className={`citation-highlight ${isActive ? 'active' : ''}`}
                          style={{
                            left: rect.left,
                            top: rect.top,
                            width: Math.max(rect.width, 10),
                            height: Math.max(rect.height, 12)
                          }}
                          title={`Citation: "${c.citedText?.substring(0, 50)}..."`}
                          onClick={() => onCitationClick && onCitationClick(c)}
                        />
                      );
                    })}
                </div>
              </div>
            ) : (
              <div style={{ textAlign: 'center', marginTop: '100px', opacity: 0.5, color: '#333' }}>
                <div style={{ fontSize: '40px', marginBottom: '20px' }}>üìÑ</div>
                <div>Upload a PDF Document to begin</div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>

  <!-- ü§ñ Google Generative AI (Gemini) - Browser-compatible SDK -->
  <script type="module">
    import { GoogleGenerativeAI } from 'https://esm.sh/@google/generative-ai';

    // ‚ö†Ô∏è Replace with your actual API key (visible in browser - OK for dev, not for production)
    const API_KEY = 'GOOGLE_GENAI_API_KEY';

    // Initialize the Gemini client
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });

    // Example: Hello flow equivalent
    async function helloFlow(name) {
      try {
        const result = await model.generateContent(`Hello Gemini, my name is ${name}`);
        const response = await result.response;
        const text = response.text();
        console.log('Gemini response:', text);
        return text;
      } catch (error) {
        console.error('Gemini error:', error);
      }
    }

    // Make it globally accessible for testing
    window.helloFlow = helloFlow;
    window.geminiModel = model;

    // Test call (uncomment to run on page load)
    // helloFlow('Chris');

    console.log('‚úÖ Google Generative AI SDK loaded. Try: helloFlow("YourName") in console');
  </script>
</body>

</html>