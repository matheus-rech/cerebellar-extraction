<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CEREBELLAR-EXTRACT - Medical Research Data Extraction</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Fuzzysort -->
  <script src="https://unpkg.com/fuzzysort@3.0.2/fuzzysort.min.js"></script>

  <style>
    /* Complete CSS */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #3498db; --primary-dark: #2980b9;
      --secondary: #2c3e50; --accent: #f39c12;
      --ai-color: #8e44ad; --success: #27ae60;
      --bg-grey: #eef2f5; --border: #dce4ec;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto; background: var(--bg-grey); }
    .app { display: flex; height: 100vh; overflow: hidden; }

    /* PDF Panel */
    .pdf-panel { flex: 1; display: flex; flex-direction: column; background: #525659; color: white; overflow: hidden; position: relative; }
    .pdf-header { padding: 12px 20px; background: #323639; border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; }
    .pdf-header h2 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }

    .file-upload-btn { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; }
    .file-upload-btn input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

    .pdf-controls { padding: 8px 16px; background: #424649; display: flex; gap: 8px; align-items: center; justify-content: center; border-bottom: 1px solid #000; }
    .control-btn { padding: 4px 8px; background: transparent; color: #f0f0f0; border: 1px solid #666; border-radius: 3px; cursor: pointer; font-size: 12px; }

    .pdf-viewer-container { flex: 1; overflow: auto; padding: 40px; display: flex; justify-content: center; align-items: flex-start; background-image: radial-gradient(#666 1px, transparent 1px); background-size: 20px 20px; }
    .pdf-canvas-wrapper { position: relative; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4); background: white; }

    /* Extraction Panel */
    .extraction-panel { width: 480px; background: white; display: flex; flex-direction: column; border-left: 1px solid var(--border); box-shadow: -2px 0 10px rgba(0, 0, 0, 0.05); }
    .extraction-header { padding: 20px; background: white; border-bottom: 1px solid var(--border); }
    .header-title-row { display: flex; justify-content: space-between; align-items: center; }
    .extraction-header h2 { font-size: 18px; color: var(--secondary); }

    .btn-ai-magic { padding: 6px 12px; font-size: 12px; font-weight: 600; background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; border: none; border-radius: 20px; cursor: pointer; box-shadow: 0 2px 5px rgba(142, 68, 173, 0.3); }

    .panel-tabs { display: flex; gap: 20px; margin-top: 10px; }
    .tab-btn { background: none; border: none; padding: 8px 0; font-size: 13px; font-weight: 600; color: #7f8c8d; cursor: pointer; position: relative; }
    .tab-btn.active { color: var(--primary); }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--primary); }

    .extraction-content { flex: 1; overflow-y: auto; background: #fcfcfc; position: relative; }

    /* Form Sections */
    .form-section { margin-bottom: 20px; background: white; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
    .section-header { padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .section-title { font-size: 14px; font-weight: 600; color: var(--secondary); }

    .form-group { margin-bottom: 14px; position: relative; }
    .form-group label { font-size: 12px; font-weight: 600; color: #7f8c8d; margin-bottom: 6px; text-transform: uppercase; }

    .form-control { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; }
    .form-control.ai-filled { border-color: #d2b4de; background: linear-gradient(to right, #fff, #fcf4ff); }

    .btn-suggest { background: none; border: none; cursor: pointer; color: #bdc3c7; padding: 2px; }
    .input-actions { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; gap: 4px; z-index: 5; }

    /* Toast */
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 24px; background: #27ae60; color: white; border-radius: 8px; z-index: 1000; }
    .toast.error { background: #e74c3c; }

    /* Hidden */
    .hidden { display: none !important; }

    /* Grid layouts */
    .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .grid-mrs { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 16px; }

    /* Annotation Bar */
    .annotation-bar {
      padding: 10px 16px;
      background: #fff;
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 1px solid var(--border);
      color: #333;
    }

    .field-select {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: white;
      font-size: 13px;
      min-width: 200px;
    }

    .toggle-highlight-btn {
      padding: 6px 12px;
      background: var(--bg-grey);
      color: #555;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .toggle-highlight-btn.active {
      background: #fff3cd;
      color: #856404;
      border-color: #ffeeba;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .toggle-highlight-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Highlight Layer */
    .highlight-layer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .highlight {
      position: absolute;
      background: rgba(255, 235, 59, 0.3);
      border: 1px solid rgba(255, 193, 7, 0.8);
      pointer-events: auto;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .highlight:hover {
      background: rgba(255, 235, 59, 0.5);
      z-index: 10;
    }

    /* Citation highlights (from Claude Native Citations) */
    .citation-highlight {
      position: absolute;
      background: rgba(138, 43, 226, 0.25);
      border: 1px solid rgba(138, 43, 226, 0.6);
      pointer-events: auto;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 2px;
    }

    .citation-highlight:hover {
      background: rgba(138, 43, 226, 0.4);
      z-index: 10;
    }

    .citation-highlight.active {
      background: rgba(138, 43, 226, 0.5);
      border-width: 2px;
      box-shadow: 0 0 8px rgba(138, 43, 226, 0.5);
    }

    #pdf-canvas {
      display: block;
    }

    /* Tables Panel */
    .tables-panel { padding: 20px; overflow-y: auto; height: 100%; }
    .tables-panel h2 { margin-bottom: 16px; color: #2c3e50; }
    .table-card { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .table-header { font-size: 16px; font-weight: 600; color: var(--secondary); margin-bottom: 12px; }

    /* Dynamic containers */
    .dynamic-container { background: white; border: 2px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 16px; }
    .remove-btn { position: absolute; top: 12px; right: 12px; padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .add-field-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 16px; }
    .field-section>h3 { font-size: 18px; margin-bottom: 16px; border-bottom: 3px solid var(--primary); padding-bottom: 8px; }
    .empty-state { text-align: center; padding: 40px 20px; color: #999; }

    .section-body { padding: 15px; display: block; }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Configure PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAMr_rIvuAvRyvAcAsLTBOLrKiw8ikvQFQ",
      authDomain: "cerebellar-extraction.firebaseapp.com",
      projectId: "cerebellar-extraction",
      storageBucket: "cerebellar-extraction.firebasestorage.app",
      messagingSenderId: "1019192870442",
      appId: "1:1019192870442:web:0bea61ff2c9435c63c6553"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    const FIELD_MAP = {
      "Study ID": "study_id", "Authors": "authors", "Year": "year", "Title": "title",
      "Sample Size": "population.sample_size", "Inclusion Criteria": "population.inclusion_criteria",
      "Intervention": "intervention.procedure", "Comparator": "comparator",
      "Mortality": "outcomes.mortality", "mRS Outcome": "outcomes.mRS_favorable",
      "Complications": "outcomes.complications"
    };

    const showToast = (message, type = 'success') => {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => document.body.removeChild(toast), 3000);
    };

    // Helper function to clean extracted text
    const cleanExtractedText = (text) => {
      if (!text) return "";
      return text.replace(/(\w)-\n(\w)/g, '$1$2').replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
    };

    /**
     * Convert PDF coordinates to canvas pixel coordinates
     * PDF coordinates: origin at bottom-left, y increases upward
     * Canvas coordinates: origin at top-left, y increases downward
     */
    const pdfToCanvasCoords = (pdfX, pdfY, pdfWidth, pdfHeight, viewport) => {
      // Apply viewport transformation
      const [a, b, c, d, e, f] = viewport.transform;

      // PDF coords to canvas coords using transformation matrix
      // For standard viewport: x' = scale * x, y' = height - (scale * y)
      const canvasX = pdfX * viewport.scale;
      const canvasY = viewport.height - (pdfY * viewport.scale);
      const canvasWidth = pdfWidth * viewport.scale;
      const canvasHeight = pdfHeight * viewport.scale;

      return {
        left: canvasX,
        top: canvasY - canvasHeight, // Adjust for height since y is bottom of rect in PDF
        width: canvasWidth,
        height: canvasHeight
      };
    };

    /**
     * Convert citation highlight from PDF space to canvas space
     */
    const convertCitationHighlight = (citation, viewport) => {
      return {
        ...citation,
        canvasRect: pdfToCanvasCoords(
          citation.x,
          citation.y,
          citation.width,
          citation.height,
          viewport
        )
      };
    };

    // Study Arms Field Component
    function StudyArmField({ data, index, onUpdate, onRemove }) {
      return (
        <div className="dynamic-container">
          <h4>Study Arm {index + 1}</h4>
          <button className="remove-btn" onClick={onRemove}>Remove</button>
          <div className="grid-2col">
            <div className="form-group">
              <label>Arm Label</label>
              <input
                type="text"
                className="form-control"
                value={data.label}
                onChange={(e) => onUpdate('label', e.target.value)}
                placeholder="e.g., SDC Group"
              />
            </div>
            <div className="form-group">
              <label>Sample Size (N)</label>
              <input
                type="number"
                className="form-control"
                value={data.sampleSize}
                onChange={(e) => onUpdate('sampleSize', e.target.value)}
              />
            </div>
          </div>
        </div>
      );
    }

    // MRS Field Component
    function MRSField({ data, index, arms, onUpdate, onRemove }) {
      const scores = [0, 1, 2, 3, 4, 5, 6];
      return (
        <div className="dynamic-container">
          <h4>mRS Distribution {index + 1}</h4>
          <button className="remove-btn" onClick={onRemove}>Remove</button>
          <div className="grid-2col">
            <div className="form-group">
              <label>Study Arm</label>
              <select
                className="form-control"
                value={data.arm}
                onChange={(e) => onUpdate('arm', e.target.value)}
              >
                <option value="">Select Arm</option>
                {arms.map((arm, idx) => (
                  <option key={idx} value={arm.label}>{arm.label}</option>
                ))}
              </select>
            </div>
            <div className="form-group">
              <label>Timepoint</label>
              <input
                type="text"
                className="form-control"
                value={data.timepoint}
                onChange={(e) => onUpdate('timepoint', e.target.value)}
                placeholder="e.g., 90 days"
              />
            </div>
          </div>
          <h5>mRS Scores (0-6)</h5>
          <div className="grid-mrs">
            {scores.map(score => (
              <div key={score} className="form-group">
                <label>{score}</label>
                <input
                  type="number"
                  className="form-control"
                  value={data.scores[score]}
                  onChange={(e) => onUpdate(`score_${score}`, e.target.value)}
                />
              </div>
            ))}
          </div>
        </div>
      );
    }

    // PDF Panel Component with Highlighting
    function PDFPanel({
      pdfFile, pdfDoc, pageNum, numPages, highlights,
      currentField, selectionMode, onFileUpload, onPageChange,
      onFieldSelect, onSelectionModeToggle, onAddHighlight,
      citationHighlights, activeCitation, onCitationClick
    }) {
      const canvasRef = useRef(null);
      const [scale, setScale] = useState(1.2);
      const [textContent, setTextContent] = useState(null);
      const [viewport, setViewport] = useState(null);

      useEffect(() => {
        if (pdfDoc) renderPage();
      }, [pdfDoc, pageNum, scale]);

      useEffect(() => {
        const canvas = canvasRef.current;
        if (!selectionMode || !canvas || !textContent) return;

        let startX, startY, isDrawing = false;
        let selectionBox = document.createElement('div');
        selectionBox.style.cssText = 'position:absolute; border: 2px dashed #f39c12; background: rgba(243, 156, 18, 0.2); pointer-events: none; z-index: 50;';

        const getCoords = (e) => {
          const rect = canvas.getBoundingClientRect();
          return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        };

        const onDown = (e) => {
          const { x, y } = getCoords(e);
          startX = x; startY = y;
          isDrawing = true;
          selectionBox.style.left = x + 'px'; selectionBox.style.top = y + 'px';
          canvas.parentElement.appendChild(selectionBox);
        };

        const onMove = (e) => {
          if (!isDrawing) return;
          const { x, y } = getCoords(e);
          const left = Math.min(startX, x), top = Math.min(startY, y);
          const width = Math.abs(x - startX), height = Math.abs(y - startY);
          selectionBox.style.left = left + 'px'; selectionBox.style.top = top + 'px';
          selectionBox.style.width = width + 'px'; selectionBox.style.height = height + 'px';
        };

        const onUp = (e) => {
          if (!isDrawing) return;
          isDrawing = false;
          const { x, y } = getCoords(e);
          selectionBox.remove();
          const rect = {
            left: Math.min(startX, x), top: Math.min(startY, y),
            width: Math.abs(x - startX), height: Math.abs(y - startY)
          };
          if (rect.width < 5 || rect.height < 5) return;
          onAddHighlight(rect, "Selected Text (Simulated Extraction)");
        };

        canvas.addEventListener('mousedown', onDown);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);

        return () => {
          canvas.removeEventListener('mousedown', onDown);
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
          if (selectionBox.parentNode) selectionBox.parentNode.removeChild(selectionBox);
        };
      }, [selectionMode, textContent]);

      const renderPage = async () => {
        try {
          const page = await pdfDoc.getPage(pageNum);
          const canvas = canvasRef.current;
          const ctx = canvas.getContext('2d');
          const vp = page.getViewport({ scale });
          setViewport(vp);
          canvas.width = vp.width;
          canvas.height = vp.height;
          await page.render({ canvasContext: ctx, viewport: vp }).promise;
          const text = await page.getTextContent();
          setTextContent(text);
        } catch (e) { console.error(e); }
      };

      return (
        <div className="pdf-panel">
          <div className="pdf-header">
            <h2>üìÑ PDF Explorer</h2>
            <label className="file-upload-btn">
              Upload PDF
              <input type="file" accept=".pdf" onChange={e => e.target.files[0] && onFileUpload(e.target.files[0])} />
            </label>
          </div>

          {pdfFile && (
            <div className="pdf-controls">
              <button className="control-btn" onClick={() => onPageChange(Math.max(1, pageNum - 1))} disabled={pageNum <= 1}>Previous</button>
              <span style={{ fontSize: '12px', margin: '0 10px' }}>Page {pageNum} / {numPages}</span>
              <button className="control-btn" onClick={() => onPageChange(Math.min(numPages, pageNum + 1))} disabled={pageNum >= numPages}>Next</button>
              <div style={{ width: '1px', height: '16px', background: '#666', margin: '0 10px' }}></div>
              <button className="control-btn" onClick={() => setScale(s => Math.max(0.5, s - 0.2))}>-</button>
              <span style={{ fontSize: '12px' }}>{Math.round(scale * 100)}%</span>
              <button className="control-btn" onClick={() => setScale(s => Math.min(3, s + 0.2))}>+</button>
            </div>
          )}

          {pdfFile && (
            <div className="annotation-bar">
              <select className="field-select" value={currentField} onChange={e => onFieldSelect(e.target.value)}>
                <option value="">-- Select Field to Extract --</option>
                {Object.keys(FIELD_MAP).map(k => <option key={k} value={k}>{k}</option>)}
              </select>

              <button
                className={`toggle-highlight-btn ${selectionMode ? 'active' : ''}`}
                onClick={() => onSelectionModeToggle(!selectionMode)}
                disabled={!currentField}
                title={!currentField ? "Select a field first" : "Click and drag on PDF"}
              >
                {selectionMode ? 'üñçÔ∏è Highlighting...' : 'Enable Selection'}
              </button>
            </div>
          )}

          <div className="pdf-viewer-container">
            {pdfFile && pdfDoc ? (
              <div className="pdf-canvas-wrapper">
                <canvas ref={canvasRef} id="pdf-canvas" style={{ cursor: selectionMode ? 'crosshair' : 'default' }} />
                <div className="highlight-layer">
                  {/* Manual selection highlights (yellow) */}
                  {highlights.filter(h => h.page === pageNum).map(h => (
                    <div key={h.id} className="highlight"
                      style={{ left: h.rect.left, top: h.rect.top, width: h.rect.width, height: h.rect.height }}
                      title={h.field + ": " + h.text} />
                  ))}

                  {/* Claude citation highlights (purple) */}
                  {viewport && citationHighlights && citationHighlights
                    .filter(c => c.page === pageNum)
                    .map((c, idx) => {
                      const rect = pdfToCanvasCoords(c.x, c.y, c.width, c.height, viewport);
                      const isActive = activeCitation && activeCitation.id === c.id;
                      return (
                        <div
                          key={`cit-${idx}-${c.page}`}
                          className={`citation-highlight ${isActive ? 'active' : ''}`}
                          style={{
                            left: rect.left,
                            top: rect.top,
                            width: Math.max(rect.width, 10),
                            height: Math.max(rect.height, 12)
                          }}
                          title={`Citation: "${c.citedText?.substring(0, 50)}..."`}
                          onClick={() => onCitationClick && onCitationClick(c)}
                        />
                      );
                    })}
                </div>
              </div>
            ) : (
              <div style={{ textAlign: 'center', marginTop: '100px', opacity: 0.5, color: '#333' }}>
                <div style={{ fontSize: '40px', marginBottom: '20px' }}>üìÑ</div>
                <div>Upload a PDF Document to begin</div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Tables Panel Component
    function TablesPanel({ pdfFile }) {
      const [tables, setTables] = useState([]);
      const [isExtracting, setIsExtracting] = useState(false);

      const extractTables = async () => {
        if (!pdfFile) {
          alert('Please upload a PDF first');
          return;
        }
        setIsExtracting(true);
        setTimeout(() => {
          setTables([
            {
              id: 1,
              page: 3,
              headers: ['Parameter', 'Group A (N=75)', 'Group B (N=75)', 'P-value'],
              rows: [
                ['Age (years)', '45.2 ¬± 8.1', '46.8 ¬± 7.9', '0.245'],
                ['Sex, male (%)', '68', '72', '0.623'],
                ['Admission GCS', '13.2 ¬± 3.4', '13.5 ¬± 3.1', '0.747']
              ]
            },
            {
              id: 2,
              page: 5,
              headers: ['Outcome', 'Arm', 'Rate (%)', '95% CI'],
              rows: [
                ['Mortality', 'SDC+EVD', '12.0', '7.1-18.9'],
                ['Mortality', 'SDC Alone', '18.7', '12.2-26.8'],
                ['Good mRS', 'SDC+EVD', '89.6', '82.3-94.8']
              ]
            }
          ]);
          setIsExtracting(false);
          showToast('Found 2 tables!', 'success');
        }, 2000);
      };

      return (
        <div className="tables-panel">
          <h2>üìä Table Extraction</h2>
          <p style={{ color: '#666', marginBottom: '20px' }}>Extract and export tables from your PDF document.</p>

          <button
            className="btn-ai-magic"
            onClick={extractTables}
            disabled={!pdfFile || isExtracting}
            style={{ marginBottom: '20px' }}
          >
            {isExtracting ? '‚è≥ Extracting...' : 'üîç Extract Tables'}
          </button>

          {tables.length > 0 && (
            <div>
              <h3>Found {tables.length} table(s)</h3>
              {tables.map(table => (
                <div key={table.id} className="table-card">
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '12px' }}>
                    <div>
                      <h4>Table {table.id} (Page {table.page})</h4>
                      <p style={{ color: '#666', fontSize: '12px', margin: 0 }}>{table.rows.length} rows √ó {table.headers.length} columns</p>
                    </div>
                    <button className="btn-ai-magic">Export CSV</button>
                  </div>
                  <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                    <thead>
                      <tr>
                        {table.headers.map((header, i) => (
                          <th key={i} style={{ padding: '6px', border: '1px solid #ddd', textAlign: 'left', background: '#f8f9fa' }}>{header}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {table.rows.map((row, idx) => (
                        <tr key={idx}>
                          {row.map((cell, i) => (
                            <td key={i} style={{ padding: '6px', border: '1px solid #ddd' }}>{cell}</td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // Main App Component
    function App() {
      // PDF State
      const [pdfFile, setPdfFile] = useState(null);
      const [pdfDoc, setPdfDoc] = useState(null);
      const [pageNum, setPageNum] = useState(1);
      const [numPages, setNumPages] = useState(0);

      // Highlight State
      const [highlights, setHighlights] = useState([]);
      const [currentField, setCurrentField] = useState('');
      const [selectionMode, setSelectionMode] = useState(false);
      const [citationHighlights, setCitationHighlights] = useState([]);
      const [activeCitation, setActiveCitation] = useState(null);

      // Form Data
      const [data, setData] = useState({
        study_id: '', authors: '', year: '', title: '',
        population: { sample_size: '', inclusion_criteria: '' },
        intervention: { procedure: '' }, comparator: '',
        outcomes: { mortality: '', mRS_favorable: '', complications: '' }
      });

      // Dynamic Fields
      const [studyArms, setStudyArms] = useState([]);
      const [mrsData, setMrsData] = useState([]);
      const [aiFilled, setAiFilled] = useState(new Set());

      // UI State
      const [activeTab, setActiveTab] = useState('extract');
      const [isLoading, setIsLoading] = useState(false);

      // Counter for IDs
      const counterRef = useRef({ arm: 0, mrs: 0 });

      // Update form field
      const updateField = (path, value) => {
        const keys = path.split('.');
        setData(prev => {
          const next = JSON.parse(JSON.stringify(prev));
          let current = next;
          for (let i = 0; i < keys.length - 1; i++) current = current[keys[i]];
          current[keys[keys.length - 1]] = value;
          return next;
        });
      };

      // Add study arm
      const addStudyArm = () => {
        const id = counterRef.current.arm++;
        setStudyArms(prev => [...prev, {
          id, label: '', sampleSize: ''
        }]);
      };

      // Add MRS data point
      const addMrsData = () => {
        const id = counterRef.current.mrs++;
        setMrsData(prev => [...prev, {
          id, arm: '', timepoint: '', scores: { 0: '', 1: '', 2: '', 3: '', 4: '', 5: '', 6: '' }
        }]);
      };

      // Update dynamic field
      const updateDynamicField = (type, id, field, value) => {
        if (type === 'arm') {
          setStudyArms(prev => prev.map(item =>
            item.id === id ? { ...item, [field]: value } : item
          ));
        } else if (type === 'mrs') {
          if (field.startsWith('score_')) {
            const scoreNum = field.split('_')[1];
            setMrsData(prev => prev.map(item =>
              item.id === id ? {
                ...item,
                scores: { ...item.scores, [scoreNum]: value }
              } : item
            ));
          } else {
            setMrsData(prev => prev.map(item =>
              item.id === id ? { ...item, [field]: value } : item
            ));
          }
        }
      };

      // Remove dynamic field
      const removeField = (type, id) => {
        if (type === 'arm') {
          setStudyArms(prev => prev.filter(item => item.id !== id));
        } else if (type === 'mrs') {
          setMrsData(prev => prev.filter(item => item.id !== id));
        }
      };

      // AI Auto-fill
      const handleAIAutofill = () => {
        if (!pdfFile) {
          showToast('Upload PDF first', 'error');
          return;
        }
        setIsLoading(true);
        setTimeout(() => {
          setData({
            study_id: 'Rocha2024',
            authors: 'Rocha et al.',
            year: '2024',
            title: 'Suboccipital Decompression with and without Duraplasty: A multicenter prospective study',
            population: { sample_size: '150', inclusion_criteria: 'Adults with symptomatic cerebellar tonsillar descent >5mm' },
            intervention: { procedure: 'Suboccipital decompressive craniectomy' },
            comparator: 'Suboccipital decompressive craniectomy without duraplasty',
            outcomes: { mortality: '12%', mRS_favorable: '89.6%', complications: '15%' }
          });
          showToast('Data extracted successfully!', 'success');
          setIsLoading(false);
        }, 2000);
      };

      // File upload
      const handleFileUpload = async (file) => {
        setPdfFile(file);
        const reader = new FileReader();
        reader.onload = async (e) => {
          const typedarray = new Uint8Array(e.target.result);
          const loadingTask = pdfjsLib.getDocument(typedarray);
          const pdf = await loadingTask.promise;
          setPdfDoc(pdf);
          setNumPages(pdf.numPages);
          setPageNum(1);
          showToast('PDF loaded successfully!');
        };
        reader.readAsArrayBuffer(file);
      };

      // Highlight handlers
      const handleAddHighlight = (rect, rawText) => {
        const text = cleanExtractedText(rawText);
        const highlight = {
          id: Date.now(),
          page: pageNum,
          field: currentField,
          rect: rect,
          text: text
        };
        setHighlights([...highlights, highlight]);

        const dataPath = FIELD_MAP[currentField];
        if (dataPath) {
          const keys = dataPath.split('.');
          let currentVal = data;
          for (let i = 0; i < keys.length - 1; i++) {
            currentVal = currentVal[keys[i]];
          }
          const existingValue = currentVal[keys[keys.length - 1]];
          const newValue = existingValue ? `${existingValue}; ${text}` : text;
          updateField(dataPath, newValue);
          showToast(`Captured: ${currentField}`);
        }
        setSelectionMode(false);
      };

      const handleFieldSelect = (field) => {
        setCurrentField(field);
        setSelectionMode(false);
      };

      const handleSelectionModeToggle = (mode) => {
        setSelectionMode(mode);
      };

      const handleCitationClick = (citation) => {
        setActiveCitation(citation);
      };

      const handlePageChange = (newPage) => {
        setPageNum(newPage);
      };

      // Form Input Component
      const FormInput = ({ label, path, type = "text", value, onChange }) => {
        const isAi = aiFilled.has(path);
        return (
          <div className="form-group">
            <label>{label}</label>
            <div style={{ position: 'relative' }}>
              <input
                type={type}
                className={`form-control ${isAi ? 'ai-filled' : ''}`}
                value={value || ''}
                onChange={e => onChange(e.target.value)}
                placeholder={`Enter ${label.toLowerCase()}`}
              />
              <div className="input-actions">
                <button className="btn-suggest" title="AI Suggest">‚ú®</button>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="app">
          {isLoading && <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(255,255,255,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
            <div style={{ padding: '20px', background: 'white', borderRadius: '8px', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}>
              <div style={{ width: '40px', height: '40px', border: '4px solid #f3f3f3', borderTop: '4px solid #8e44ad', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto 10px' }}></div>
              <p>Processing with AI...</p>
            </div>
          </div>}

          {/* PDF Panel with Highlighting */}
          <PDFPanel
            pdfFile={pdfFile}
            pdfDoc={pdfDoc}
            pageNum={pageNum}
            numPages={numPages}
            highlights={highlights}
            currentField={currentField}
            selectionMode={selectionMode}
            onFileUpload={handleFileUpload}
            onPageChange={handlePageChange}
            onFieldSelect={handleFieldSelect}
            onSelectionModeToggle={handleSelectionModeToggle}
            onAddHighlight={handleAddHighlight}
            citationHighlights={citationHighlights}
            activeCitation={activeCitation}
            onCitationClick={handleCitationClick}
          />

          {/* Extraction Panel */}
          <div className="extraction-panel">
            <div className="extraction-header">
              <div className="header-title-row">
                <h2>üìã Extraction Assistant</h2>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 10 }}>
                <button className="btn-ai-magic" onClick={handleAIAutofill} disabled={!pdfFile}>
                  ‚ú® Auto-Fill
                </button>
              </div>
              <div className="panel-tabs">
                <button className={`tab-btn ${activeTab === 'extract' ? 'active' : ''}`} onClick={() => setActiveTab('extract')}>üìù Form</button>
                <button className={`tab-btn ${activeTab === 'tables' ? 'active' : ''}`} onClick={() => setActiveTab('tables')}>üìä Tables</button>
                <button className={`tab-btn ${activeTab === 'figures' ? 'active' : ''}`} onClick={() => setActiveTab('figures')}>üñºÔ∏è Figures</button>
                <button className={`tab-btn ${activeTab === 'arms' ? 'active' : ''}`} onClick={() => setActiveTab('arms')}>üìà Analysis</button>
              </div>
            </div>

            <div className="extraction-content">
              {/* Form Tab */}
              {activeTab === 'extract' && (
                <div className="extraction-form-container">
                  {/* Study Info */}
                  <div className="form-section">
                    <div className="section-header">
                      <div className="section-title">üÜî Study Identification</div>
                    </div>
                    <div className="section-body">
                      <FormInput label="Study ID" value={data.study_id} onChange={val => updateField('study_id', val)} />
                      <FormInput label="Authors" value={data.authors} onChange={val => updateField('authors', val)} />
                      <div style={{ display: 'flex', gap: '10px' }}>
                        <div style={{ flex: 1 }}><FormInput label="Year" value={data.year} onChange={val => updateField('year', val)} /></div>
                        <div style={{ flex: 2 }}><FormInput label="Title" value={data.title} onChange={val => updateField('title', val)} /></div>
                      </div>
                    </div>
                  </div>

                  {/* Population */}
                  <div className="form-section">
                    <div className="section-header">
                      <div className="section-title">üë• Population</div>
                    </div>
                    <div className="section-body">
                      <FormInput label="Sample Size" value={data.population.sample_size} onChange={val => updateField('population.sample_size', val)} />
                      <FormInput label="Inclusion Criteria" value={data.population.inclusion_criteria} onChange={val => updateField('population.inclusion_criteria', val)} />
                    </div>
                  </div>

                  {/* Intervention */}
                  <div className="form-section">
                    <div className="section-header">
                      <div className="section-title">üíâ Intervention</div>
                    </div>
                    <div className="section-body">
                      <FormInput label="Procedure" value={data.intervention.procedure} onChange={val => updateField('intervention.procedure', val)} />
                      <FormInput label="Comparator" value={data.comparator} onChange={val => updateField('comparator', val)} />
                    </div>
                  </div>

                  {/* Outcomes */}
                  <div className="form-section">
                    <div className="section-header">
                      <div className="section-title">üìâ Outcomes</div>
                    </div>
                    <div className="section-body">
                      <div style={{ display: 'flex', gap: '10px' }}>
                        <div style={{ flex: 1 }}><FormInput label="Mortality" value={data.outcomes.mortality} onChange={val => updateField('outcomes.mortality', val)} /></div>
                        <div style={{ flex: 1 }}><FormInput label="Good mRS" value={data.outcomes.mRS_favorable} onChange={val => updateField('outcomes.mRS_favorable', val)} /></div>
                      </div>
                      <FormInput label="Complications" value={data.outcomes.complications} onChange={val => updateField('outcomes.complications', val)} />
                    </div>
                  </div>
                </div>
              )}

              {/* Tables Tab */}
              {activeTab === 'tables' && (
                <TablesPanel pdfFile={pdfFile} />
              )}

              {/* Figures Tab */}
              {activeTab === 'figures' && (
                <div style={{ padding: '20px', height: '100%' }}>
                  <h2>üñºÔ∏è Figure Extraction</h2>
                  <p style={{ color: '#666', marginBottom: '20px' }}>Extract figures, charts, and images from your PDF.</p>
                  <button className="btn-ai-magic" style={{ marginBottom: '20px' }}>üîç Extract Figures</button>
                  <div style={{ padding: '40px', textAlign: 'center', background: '#f8f9fa', borderRadius: '8px', border: '2px dashed #dee2e6' }}>
                    <p>Figure extraction placeholder</p>
                  </div>
                </div>
              )}

              {/* Analysis Tab - Study Arms & MRS */}
              {activeTab === 'arms' && (
                <div style={{ padding: '20px', height: '100%', overflowY: 'auto' }}>
                  <h2>üìà Advanced Analysis</h2>
                  <p style={{ color: '#666', marginBottom: '24px' }}>Manage study arms and mRS score distributions for detailed analysis.</p>

                  {/* Study Arms */}
                  <div className="field-section">
                    <h3>üìä Study Arms</h3>
                    <p className="field-section-description">Define treatment groups and sample sizes.</p>
                    <button className="add-field-btn" onClick={addStudyArm}>
                      <span>+</span> Add Study Arm
                    </button>
                    {studyArms.length === 0 ? (
                      <div className="empty-state">
                        <span style={{ fontSize: '32px', marginBottom: '8px', display: 'block' }}>üìä</span>
                        Add your first study arm to begin detailed analysis
                      </div>
                    ) : (
                      studyArms.map((arm, i) => (
                        <StudyArmField
                          key={arm.id}
                          data={arm}
                          index={i}
                          onUpdate={(field, value) => updateDynamicField('arm', arm.id, field, value)}
                          onRemove={() => removeField('arm', arm.id)}
                        />
                      ))
                    )}
                  </div>

                  {/* mRS Distributions */}
                  <div className="field-section">
                    <h3>üìà mRS Score Distributions</h3>
                    <p className="field-section-description">Track modified Rankin Scale outcomes by study arm and timepoint.</p>
                    <button className="add-field-btn" onClick={addMrsData}>
                      <span>+</span> Add mRS Data Point
                    </button>
                    {mrsData.length === 0 ? (
                      <div className="empty-state">
                        <span style={{ fontSize: '32px', marginBottom: '8px', display: 'block' }}>üìà</span>
                        No mRS data points added yet
                      </div>
                    ) : (
                      mrsData.map((mrs, i) => (
                        <MRSField
                          key={mrs.id}
                          data={mrs}
                          index={i}
                          arms={studyArms}
                          onUpdate={(field, value) => updateDynamicField('mrs', mrs.id, field, value)}
                          onRemove={() => removeField('mrs', mrs.id)}
                        />
                      ))
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Render the App
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
